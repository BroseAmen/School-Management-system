<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Digital Learning Space</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6; /* A slightly darker gray for contrast */
        }
        /* Simple animation for new items */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .new-item, .chat-message {
            animation: fadeIn 0.4s ease-out;
        }
        /* Custom scrollbar for a cleaner look */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #e5e7eb;
        }
        ::-webkit-scrollbar-thumb {
            background: #9ca3af;
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #6b7280;
        }
        .chat-bubble-bot {
            background-color: #e5e7eb; /* gray-200 */
            align-self: flex-start;
        }
        .chat-bubble-user {
            background-color: #4f46e5; /* indigo-600 */
            color: white;
            align-self: flex-end;
        }
        .typing-indicator span {
            height: 8px;
            width: 8px;
            background-color: #9ca3af; /* gray-400 */
            display: inline-block;
            border-radius: 50%;
            animation: bounce 1.4s infinite ease-in-out both;
        }
        .typing-indicator span:nth-child(1) { animation-delay: -0.32s; }
        .typing-indicator span:nth-child(2) { animation-delay: -0.16s; }
        @keyframes bounce {
            0%, 80%, 100% { transform: scale(0); }
            40% { transform: scale(1.0); }
        }
         #gradebook-modal, #ai-assistant-modal, #assessment-modal, #student-details-modal, #what-if-modal, #add-user-modal, #assign-test-modal, #grade-details-modal, #assignment-details-modal, #attendance-modal, #schedule-manager-modal, #confirmation-modal, #live-activity-modal {
            display: none; /* Hidden by default */
        }
        .grade-input {
            width: 60px;
            text-align: center;
        }
         #ai-response-container p, #ai-response-container li {
            margin-bottom: 0.75rem;
        }
        #ai-response-container h4 {
            font-weight: 600;
            margin-top: 1rem;
            margin-bottom: 0.5rem;
        }
        #ai-response-container ul {
            list-style-type: disc;
            list-style-position: inside;
            padding-left: 1rem;
        }
        /* Styles for Assessment Tool */
        .assessment-option {
            transition: all 0.2s ease-in-out;
        }
        .assessment-option.selected {
            background-color: #4f46e5; /* indigo-600 */
            color: white;
            border-color: #4f46e5;
        }
        /* Correct/Incorrect styles for review */
        .review-option.correct {
            border-left: 4px solid #22c55e; /* green-500 */
            background-color: #f0fdf4; /* green-50 */
        }
        .review-option.incorrect {
             border-left: 4px solid #ef4444; /* red-500 */
             background-color: #fef2f2; /* red-50 */
        }
        .review-option.selected-by-user::before {
            content: 'Your Answer';
            font-size: 0.75rem;
            font-weight: 600;
            color: #4f46e5; /* indigo-600 */
            position: absolute;
            top: -10px;
            left: 10px;
            background: white;
            padding: 0 4px;
        }
       
        .what-if-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            background: #4f46e5;
            cursor: pointer;
            border-radius: 50%;
        }
        .attendance-btn {
            cursor: pointer;
            padding: 4px 8px;
            border-radius: 9999px;
            font-weight: 500;
            font-size: 0.8rem;
            min-width: 32px;
            border: 1px solid transparent;
        }
        .attendance-btn.active {
            font-weight: 700;
        }
        .attendance-p { background-color: #dcfce7; color: #166534; border-color: #166534;}
        .attendance-a { background-color: #fee2e2; color: #991b1b; border-color: #991b1b;}
        .attendance-t { background-color: #fef9c3; color: #854d0e; border-color: #854d0e;}
       
        .timeline {
            position: relative;
            padding-left: 30px;
        }
        .timeline::before {
            content: '';
            position: absolute;
            left: 10px;
            top: 10px;
            bottom: 10px;
            width: 2px;
            background-color: #d1d5db; /* gray-300 */
        }
        .timeline-item::before {
            content: '';
            position: absolute;
            left: -24px;
            top: 50%;
            transform: translateY(-50%);
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background-color: #4f46e5; /* indigo-600 */
            border: 2px solid white;
        }
        /* Tab styling */
        .tab-btn {
            transition: all 0.2s ease-in-out;
        }
        .tab-btn.active {
            border-color: #4f46e5;
            color: #4f46e5;
            font-weight: 600;
        }
        /* Sticky footer for gradebook */
        #teacher-gradebook-view tfoot {
            position: sticky;
            bottom: 0;
            background-color: #e5e7eb; /* gray-200 */
            z-index: 10;
        }
        .grade-cell {
            cursor: pointer;
            position: relative;
        }
        .student-name-cell {
            cursor: pointer;
            font-weight: 500;
        }
        .student-name-cell:hover {
            background-color: #f9fafb; /* gray-50 */
            color: #4f46e5; /* indigo-600 */
        }
        .status-missing { background-color: #fef2f2; }
        .status-late { background-color: #fffbeb; }
        .status-excused { background-color: #f0fdf4; }
        .status-incomplete { background-color: #fafafa; }
        .comment-indicator {
            position: absolute;
            top: 2px;
            right: 2px;
            width: 8px;
            height: 8px;
            background-color: #4f46e5;
            border-radius: 50%;
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800 flex items-center justify-center min-h-screen">

    <div class="container mx-auto p-4 md:p-8 max-w-7xl w-full">

        <!-- Role Selection -->
        <div id="role-selection" class="text-center py-10">
            <h2 id="welcome-heading" class="text-3xl font-bold mb-4">Welcome to the Learning Space</h2>
           
            <div id="role-selection-loader">
                <svg class="animate-spin h-8 w-8 text-indigo-600 mx-auto" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
                <p class="mt-2 text-gray-600">Connecting securely...</p>
            </div>

            <div id="role-buttons" class="hidden">
                <p id="welcome-subheading" class="text-gray-600 mb-8">Please select your role.</p>
                <div class="flex flex-col sm:flex-row justify-center gap-4">
                    <button id="teacher-btn" class="bg-indigo-600 text-white font-semibold py-3 px-6 rounded-lg hover:bg-indigo-700 transition shadow-md text-lg">
                        I'm a Teacher
                    </button>
                    <button id="student-btn" class="bg-purple-600 text-white font-semibold py-3 px-6 rounded-lg hover:bg-purple-700 transition shadow-md text-lg">
                        I'm a Student
                    </button>
                     <button id="admin-btn" class="bg-gray-700 text-white font-semibold py-3 px-6 rounded-lg hover:bg-gray-800 transition shadow-md text-lg">
                        I'm an Admin
                    </button>
                </div>
            </div>
        </div>

        <!-- Chatbot -->
        <div id="chatbot-container" class="hidden max-w-lg mx-auto bg-white rounded-lg shadow-xl">
            <div class="p-4 border-b">
                <h3 id="chatbot-title" class="text-lg font-semibold text-center"></h3>
            </div>
            <div id="chatbot-messages" class="p-4 h-96 overflow-y-auto flex flex-col space-y-4"></div>
            <div id="chatbot-typing" class="p-4 hidden">
                <div class="typing-indicator"><span></span><span></span><span></span></div>
            </div>
            <div class="p-4 border-t">
                <form id="chatbot-form">
                    <input type="text" id="chatbot-input" placeholder="Type your answer..." class="w-full px-4 py-2 border rounded-md focus:ring-indigo-500 focus:border-indigo-500" autocomplete="off">
                </form>
            </div>
        </div>

        <!-- Main App Container (hidden by default) -->
        <div id="app-container" class="hidden">
            <header class="mb-10 relative">
                <div class="max-w-4xl mx-auto text-center">
                    <h1 class="text-4xl md:text-5xl font-bold text-gray-900">Learning Space</h1>
                     <p id="user-display" class="text-base text-gray-500 mt-4 text-center"></p>
                </div>
                <button id="logout-btn" class="absolute top-0 right-0 bg-red-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-red-700 transition shadow-sm text-sm">Logout</button>
            </header>
           
            <div id="loader" class="text-center py-10">
                 <svg class="animate-spin h-8 w-8 text-indigo-600 mx-auto" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
                <p class="mt-2 text-gray-600">Loading your space...</p>
            </div>

            <!-- Teacher Dashboard -->
             <div id="teacher-dashboard" class="hidden max-w-6xl mx-auto grid grid-cols-1 lg:grid-cols-3 gap-8">
                <!-- Main Content Column -->
                <div class="lg:col-span-2 space-y-8">
                     <div class="bg-white p-8 rounded-xl shadow-md">
                        <h2 class="text-2xl font-bold mb-4 text-gray-800">ðŸ“¢ Class Announcements</h2>
                        <form id="add-announcement-form">
                            <textarea id="announcement-text" class="w-full p-2 border rounded-md" rows="3" placeholder="Write an announcement for your class..." required></textarea>
                            <button type="submit" class="mt-2 w-full bg-blue-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-blue-700 transition">Post Announcement</button>
                        </form>
                        <div id="announcement-list" class="mt-6 space-y-4 max-h-96 overflow-y-auto">
                            <!-- Announcements will be rendered here -->
                        </div>
                    </div>
                     <div id="add-resource-container" class="bg-white p-8 rounded-xl shadow-md">
                         <form id="add-resource-form">
                            <h2 class="text-2xl font-bold mb-6 text-gray-800">Add a New Resource</h2>
                            <div class="space-y-4">
                                <div>
                                    <label for="resource-title" class="block text-sm font-medium text-gray-700 mb-1">Title</label>
                                    <input type="text" id="resource-title" name="title" required class="w-full px-4 py-2 border border-gray-300 rounded-md focus:ring-indigo-500 focus:border-indigo-500">
                                </div>
                                <div>
                                    <label for="resource-url" class="block text-sm font-medium text-gray-700 mb-1">URL</label>
                                    <input type="url" id="resource-url" name="url" required class="w-full px-4 py-2 border border-gray-300 rounded-md focus:ring-indigo-500 focus:border-indigo-500">
                                </div>
                            </div>
                            <div class="mt-6"><label class="flex items-center"><input type="checkbox" id="share-with-students-checkbox" class="h-4 w-4 text-indigo-600 focus:ring-indigo-500"><span class="ml-3 text-sm text-gray-600">Share with all students</span></label></div>
                            <button type="submit" class="mt-6 w-full bg-indigo-600 text-white font-semibold py-3 px-4 rounded-lg hover:bg-indigo-700 transition shadow-md">Add Resource</button>
                        </form>
                    </div>
                    <div class="bg-white p-8 rounded-xl shadow-md">
                        <h2 class="text-2xl font-bold mb-4 text-gray-800">My Private Resources</h2>
                        <div id="personal-resource-list" class="space-y-4"></div>
                        <div id="empty-state" class="hidden text-center py-4">
                            <p class="text-sm text-gray-500 mt-1">Add a link using the form above.</p>
                        </div>
                    </div>
                </div>
                <!-- Apps Column -->
                <div class="lg:col-span-1">
                     <div class="bg-white p-6 rounded-xl shadow-md">
                         <h2 class="text-xl font-bold mb-4 text-gray-800">Applications</h2>
                         <div class="grid grid-cols-1 gap-4">
                              <a href="#" id="open-teachervue-btn" class="flex flex-col items-center justify-center p-4 bg-gray-50 hover:bg-gray-100 rounded-lg transition border border-gray-200">
                                 <svg class="w-10 h-10 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7v8a2 2 0 002 2h4M8 7a2 2 0 012-2h4a2 2 0 012 2v8a2 2 0 01-2 2h-4a2 2 0 01-2-2l-4-4z"></path></svg>
                                 <span class="font-semibold text-gray-700 mt-2">TeacherVUE</span>
                              </a>
                               <a href="#" id="open-teacher-attendance-btn" class="flex flex-col items-center justify-center p-4 bg-gray-50 hover:bg-gray-100 rounded-lg transition border border-gray-200">
                                 <svg class="w-10 h-10 text-cyan-600" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg>
                                 <span class="font-semibold text-gray-700 mt-2">Attendance</span>
                              </a>
                              <a href="#" id="open-assessment-btn" class="flex flex-col items-center justify-center p-4 bg-gray-50 hover:bg-gray-100 rounded-lg transition border border-gray-200">
                                 <svg class="w-10 h-10 text-indigo-600" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01"></path></svg>
                                 <span class="font-semibold text-gray-700 mt-2">Securely Assignments</span>
                              </a>
                              <a href="https://classroom.google.com/" target="_blank" class="flex flex-col items-center justify-center p-4 bg-gray-50 hover:bg-gray-100 rounded-lg transition border border-gray-200">
                                   <svg class="w-10 h-10 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M12 14l9-5-9-5-9 5 9 5z"></path><path d="M12 14l6.16-3.422a12.083 12.083 0 01.665 6.479A11.952 11.952 0 0012 20.055a11.952 11.952 0 00-6.824-2.998 12.078 12.078 0 01.665-6.479L12 14z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 14l9-5-9-5-9 5 9 5zm0 0l6.16-3.422a12.083 12.083 0 01.665 6.479A11.952 11.952 0 0012 20.055a11.952 11.952 0 00-6.824-2.998 12.078 12.078 0 01.665-6.479L12 14z"></path></svg>
                                   <span class="font-semibold text-gray-700 mt-2">Google Classroom</span>
                               </a>
                         </div>
                     </div>
                </div>
            </div>

            <!-- Student Dashboard -->
            <div id="student-dashboard" class="hidden">
                 <!-- Student dashboard content is now generated by JS -->
            </div>
           
            <!-- Admin Dashboard -->
            <div id="admin-dashboard" class="hidden max-w-6xl mx-auto bg-white p-8 rounded-xl shadow-md">
                <h2 class="text-3xl font-bold mb-6 text-gray-800">Admin Dashboard</h2>
                 <div class="mb-6 flex space-x-4">
                    <button id="add-user-btn" class="bg-green-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-green-700 transition shadow-sm">
                        + Add User
                    </button>
                    <button id="open-schedule-manager-btn" class="bg-blue-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-blue-700 transition shadow-sm">
                        <i class="fas fa-calendar-alt mr-2"></i> Student Schedules
                    </button>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                    <div>
                        <h3 class="text-xl font-bold mb-4">Teachers</h3>
                        <div id="admin-teacher-list" class="space-y-2"></div>
                    </div>
                    <div>
                        <h3 class="text-xl font-bold mb-4">Students</h3>
                        <div id="admin-student-list" class="space-y-2"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Gradebook Modal -->
        <div id="gradebook-modal" class="fixed inset-0 bg-gray-800 bg-opacity-75 flex items-center justify-center p-4">
            <div class="bg-white rounded-xl shadow-2xl w-full max-w-7xl h-[95vh] flex flex-col">
                <div class="p-4 border-b flex justify-between items-center flex-shrink-0">
                    <h2 id="gradebook-title" class="text-2xl font-bold">Gradebook</h2>
                    <button id="close-gradebook-btn" class="text-gray-500 hover:text-gray-800 text-3xl leading-none">&times;</button>
                </div>
                <div class="flex-grow overflow-hidden flex flex-col">
                    <!-- Teacher Gradebook View -->
                    <div id="teacher-gradebook-view" class="w-full flex-grow flex flex-col p-4 hidden">
                         <div id="teacher-grades-content" class="flex-grow flex flex-col overflow-hidden">
                            <div class="flex-shrink-0 grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
                                <div class="bg-gray-50 p-6 rounded-lg shadow-sm">
                                    <h3 class="font-bold text-lg mb-2">Grading Categories</h3>
                                    <form id="category-form" class="flex gap-2 mb-2">
                                        <input type="text" id="category-name" placeholder="Category Name" class="w-full p-2 border rounded-md" required>
                                        <input type="number" id="category-weight" placeholder="Weight %" class="w-28 p-2 border rounded-md" required min="1" max="100">
                                        <button type="submit" class="bg-blue-600 text-white px-4 rounded-md hover:bg-blue-700 font-bold">+</button>
                                    </form>
                                    <div id="category-list" class="text-sm space-y-1 mt-3"></div>
                                    <p id="total-weight" class="font-bold text-lg mt-2"></p>
                                </div>
                                <div class="bg-gray-50 p-6 rounded-lg shadow-sm">
                                     <h3 class="font-bold text-lg mb-2">Create Assignment</h3>
                                    <form id="assignment-form" class="space-y-2">
                                        <input type="text" id="assignment-name" placeholder="Assignment Name" class="w-full p-2 border rounded-md" required>
                                        <div class="flex gap-2">
                                            <select id="assignment-category" class="w-full p-2 border rounded-md" required></select>
                                            <input type="number" id="assignment-points" placeholder="Points" class="w-28 p-2 border rounded-md" required min="0">
                                        </div>
                                        <input type="date" id="assignment-due-date" class="w-full p-2 border rounded-md">
                                        <button type="submit" class="w-full bg-green-600 text-white p-2 rounded-md hover:bg-green-700 font-semibold">Add Assignment</button>
                                    </form>
                                </div>
                                <div class="bg-gray-50 p-6 rounded-lg shadow-sm">
                                     <h3 class="font-bold text-lg mb-2 text-indigo-800">AI Assistant</h3>
                                     <p class="text-sm text-gray-600 mb-3">Prompt the AI to create assignments, add grades, or get insights.</p>
                                     <form id="ai-prompt-form" class="flex gap-2">
                                         <input type="text" id="ai-prompt-input" placeholder="e.g., Create a quiz..." class="w-full p-2 border rounded-md">
                                         <button type="submit" class="bg-indigo-600 text-white p-2 rounded-md hover:bg-indigo-700 font-semibold">Go</button>
                                     </form>
                                </div>
                             </div>
                             <div class="flex-grow overflow-auto bg-white rounded-lg shadow-md">
                                <table class="min-w-full divide-y divide-gray-200">
                                    <thead class="bg-gray-100 sticky top-0">
                                        <tr>
                                            <th class="px-4 py-3 text-left text-xs font-bold text-gray-600 uppercase tracking-wider sticky left-0 bg-gray-100 z-10">Student Name</th>
                                            <th id="assignment-headers" class="px-4 py-3 text-left text-xs font-bold text-gray-600 uppercase tracking-wider"></th>
                                            <th class="px-4 py-3 text-left text-xs font-bold text-gray-600 uppercase tracking-wider">Final Grade</th>
                                        </tr>
                                    </thead>
                                    <tbody id="gradebook-body" class="bg-white divide-y divide-gray-200"></tbody>
                                    <tfoot id="gradebook-footer">
                                        <!-- Averages will be injected here -->
                                    </tfoot>
                                </table>
                                <div id="no-students-msg" class="hidden text-center p-10 text-gray-500">No students have registered yet.</div>
                             </div>
                         </div>
                    </div>
                     <!-- Student Gradebook View (New List View) -->
                    <div id="student-gradebook-list-view" class="w-full p-6 overflow-auto bg-gray-50 hidden">
                         <!-- Injected by renderStudentMultiClassView -->
                    </div>
                     <!-- Student Gradebook View (New Detail View) -->
                    <div id="student-gradebook-detail-view" class="w-full p-6 overflow-auto bg-gray-50 hidden">
                        <!-- Injected by renderStudentGradebookDetailView -->
                    </div>
                </div>
            </div>
        </div>

        <!-- Attendance Modal -->
        <div id="attendance-modal" class="fixed inset-0 bg-gray-800 bg-opacity-75 flex items-center justify-center p-4">
            <div class="bg-white rounded-xl shadow-2xl w-full max-w-4xl h-[90vh] flex flex-col">
                <div class="p-4 border-b flex justify-between items-center">
                    <h2 id="attendance-title" class="text-2xl font-bold">Attendance</h2>
                    <button id="close-attendance-modal-btn" class="text-gray-500 hover:text-gray-800 text-3xl leading-none">&times;</button>
                </div>
                <!-- Teacher Attendance -->
                <div id="teacher-attendance-content" class="hidden flex-grow flex flex-col overflow-hidden p-6">
                     <div class="flex justify-between items-center mb-4 flex-shrink-0">
                        <h3 class="text-xl font-bold">Daily Attendance</h3>
                        <input type="date" id="attendance-date" class="p-2 border rounded-md">
                     </div>
                      <div class="overflow-auto bg-white rounded-lg shadow-md flex-grow">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-100 sticky top-0">
                                <tr>
                                    <th class="px-4 py-3 text-left text-xs font-bold text-gray-600 uppercase tracking-wider">Student Name</th>
                                    <th class="px-4 py-3 text-center text-xs font-bold text-gray-600 uppercase tracking-wider">Status</th>
                                </tr>
                            </thead>
                            <tbody id="attendance-body" class="bg-white divide-y divide-gray-200"></tbody>
                        </table>
                      </div>
                 </div>
                 <!-- Student Attendance -->
                 <div id="student-attendance-content" class="hidden flex-grow flex flex-col overflow-auto p-6">
                    <!-- Student attendance details will be injected here -->
                 </div>
            </div>
        </div>
       
        <!-- Schedule Manager Modal (Admin) -->
        <div id="schedule-manager-modal" class="fixed inset-0 bg-gray-800 bg-opacity-75 flex items-center justify-center p-4">
            <div class="bg-white rounded-xl shadow-2xl w-full max-w-3xl h-[90vh] flex flex-col">
                <div class="p-4 border-b flex justify-between items-center">
                    <h2 class="text-2xl font-bold">Schedule Manager</h2>
                    <button id="close-schedule-manager-btn" class="text-gray-500 hover:text-gray-800 text-3xl leading-none">&times;</button>
                </div>
                <div class="p-6 overflow-y-auto">
                    <div class="mb-4">
                        <label for="schedule-student-select" class="block text-sm font-medium text-gray-700">Select Student</label>
                        <select id="schedule-student-select" class="w-full mt-1 p-2 border rounded-md">
                            <option value="">-- Select a Student --</option>
                        </select>
                    </div>
                    <div id="schedule-editor" class="hidden">
                        <table class="min-w-full bg-white border">
                            <thead class="bg-gray-100">
                                <tr>
                                    <th class="px-4 py-2 text-left">Period</th>
                                    <th class="px-4 py-2 text-left">Class Name</th>
                                    <th class="px-4 py-2 text-left">Teacher</th>
                                </tr>
                            </thead>
                            <tbody id="schedule-editor-body">
                                <!-- Schedule rows will be injected here -->
                            </tbody>
                        </table>
                         <div class="mt-6 text-right">
                            <button id="save-schedule-btn" class="bg-indigo-600 text-white font-semibold py-2 px-6 rounded-lg hover:bg-indigo-700 transition">Save Schedule</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
       
        <!-- AI Assistant Modal -->
        <div id="ai-assistant-modal" class="fixed inset-0 bg-gray-800 bg-opacity-75 flex items-center justify-center p-4">
            <div class="bg-white rounded-xl shadow-2xl w-full max-w-3xl h-[90vh] flex flex-col">
                <div class="p-4 border-b flex justify-between items-center">
                    <h2 class="text-2xl font-bold text-indigo-800">AI Assistant</h2>
                    <button id="close-ai-modal-btn" class="text-gray-500 hover:text-gray-800 text-3xl leading-none">&times;</button>
                </div>
                <div id="ai-response-container" class="p-6 overflow-y-auto">
                    <!-- AI response will be injected here -->
                </div>
                <div id="ai-loader" class="hidden flex-col items-center justify-center h-full">
                     <svg class="animate-spin h-10 w-10 text-indigo-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
                    <p class="mt-4 text-gray-600">Your AI assistant is on it...</p>
                </div>
            </div>
        </div>

        <!-- Assessment Modal -->
        <div id="assessment-modal" class="fixed inset-0 bg-gray-100 flex flex-col">
            <div class="p-4 bg-white border-b flex justify-between items-center flex-shrink-0">
                <h2 id="assessment-title" class="text-2xl font-bold">Securely Assignments</h2>
                <button id="close-assessment-btn" class="text-gray-500 hover:text-gray-800 text-3xl leading-none">&times;</button>
            </div>
            <div class="flex-grow overflow-y-auto p-8 flex items-center justify-center">
               
                <div id="assessment-view-container" class="w-full max-w-4xl">
                    <!-- Teacher Assessment Dashboard -->
                    <div id="teacher-assessment-dashboard" class="hidden">
                        <div class="flex justify-between items-center mb-6">
                            <h3 class="text-3xl font-bold">Assignments Dashboard</h3>
                            <div class="flex gap-2">
                                 <button id="live-activity-btn" class="bg-teal-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-teal-700 transition shadow-sm">
                                    <i class="fas fa-satellite-dish mr-2"></i> Live Activity
                                </button>
                                <button id="manual-create-test-btn" class="bg-blue-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-blue-700 transition shadow-sm">
                                    + Create Manually
                                </button>
                                <button id="ai-create-test-btn" class="bg-green-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-green-700 transition shadow-sm">
                                    <i class="fas fa-magic mr-2"></i> Create with AI
                                </button>
                            </div>
                        </div>
                        <div id="assessment-list-container"></div>
                    </div>

                    <!-- Student Assessment Dashboard -->
                    <div id="student-assessment-dashboard" class="hidden">
                        <h3 class="text-3xl font-bold mb-6">Your Assignments</h3>
                        <div id="student-assessment-list-container"></div>
                    </div>

                    <!-- AI Assessment Creator -->
                    <div id="ai-assessment-creator" class="hidden">
                        <form id="ai-assessment-form" class="bg-white p-8 rounded-xl shadow-md">
                            <div class="flex justify-between items-center mb-6">
                                <h3 class="text-2xl font-bold">Create an Assignment with AI</h3>
                                <button type="button" id="cancel-ai-assessment-creation" class="text-2xl text-gray-500">&times;</button>
                            </div>
                            <div class="space-y-4">
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <div><label for="ai-test-name" class="font-semibold">Name of Assignment</label><input type="text" id="ai-test-name" class="w-full p-2 border rounded-md mt-1" required></div>
                                    <div>
                                        <label for="ai-release-scores" class="font-semibold">Release Scores</label>
                                        <select id="ai-release-scores" class="w-full p-2 border rounded-md mt-1">
                                            <option value="immediate">Immediately</option>
                                            <option value="manual">Manually, after review</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <div><label for="ai-attempts" class="font-semibold">Attempts Allowed</label><select id="ai-attempts" class="w-full p-2 border rounded-md mt-1"><option value="1">One</option><option value="unlimited">Unlimited</option></select></div>
                                    <div><label for="ai-test-timer" class="font-semibold">Time Limit (minutes)</label><input type="number" id="ai-test-timer" value="0" min="0" class="w-full p-2 border rounded-md mt-1" placeholder="0 for no timer"></div>
                                </div>
                               
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <div><label for="ai-grade-level" class="font-semibold">Grade Level</label><select id="ai-grade-level" class="w-full p-2 border rounded-md mt-1"><option>5th Grade</option><option>6th Grade</option><option>7th Grade</option><option>8th Grade</option><option selected>9th Grade</option><option>10th Grade</option><option>11th Grade</option><option>12th Grade</option><option>College</option></select></div>
                                    <div><label for="ai-num-questions" class="font-semibold"># of Questions</label><input type="number" id="ai-num-questions" value="5" class="w-full p-2 border rounded-md mt-1" min="1" max="20"></div>
                                </div>
                                 <div><label class="font-semibold">Topic</label><textarea id="ai-topic" class="w-full p-2 border rounded-md mt-1" placeholder="e.g., The American Revolution, cellular respiration..." required></textarea></div>
                                <div>
                                    <label class="font-semibold">Question Types</label>
                                    <p class="text-sm text-gray-500">The AI will create a mix of the selected types.</p>
                                    <div class="flex space-x-4 mt-2" id="ai-question-types">
                                        <label class="flex items-center"><input type="checkbox" value="multiple-choice" checked class="mr-2">Multiple Choice</label>
                                        <label class="flex items-center"><input type="checkbox" value="true-false" checked class="mr-2">True/False</label>
                                        <label class="flex items-center"><input type="checkbox" value="fill-in-the-blank" checked class="mr-2">Fill-in-the-Blank</label>
                                    </div>
                                </div>
                                 <div class="mt-2 border-t pt-4">
                                    <label class="flex items-center">
                                        <input type="checkbox" id="ai-enable-proctoring" class="h-4 w-4 text-indigo-600 focus:ring-indigo-500 border-gray-300 rounded">
                                        <span class="ml-3 font-semibold text-gray-700">Enable Full-Screen Monitoring</span>
                                        <i class="fas fa-info-circle ml-2 text-gray-400" title="Students will be required to complete this in full-screen mode. Exits will be flagged for review."></i>
                                    </label>
                                </div>
                            </div>
                            <div id="ai-error-message" class="text-red-600 mt-4 text-center"></div>
                            <div class="mt-6"><button type="submit" id="generate-test-btn" class="w-full bg-green-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-green-700 transition">Generate Assignment</button></div>
                        </form>
                    </div>

                     <!-- Manual Assessment Creator -->
                    <div id="manual-assessment-creator" class="hidden bg-white p-8 rounded-xl shadow-md">
                        <div class="flex justify-between items-center mb-6">
                            <h3 class="text-2xl font-bold">Create an Assignment Manually</h3>
                            <button type="button" id="cancel-manual-assessment-creation" class="text-2xl text-gray-500">&times;</button>
                        </div>
                        <div id="manual-test-error" class="hidden p-3 mb-4 text-sm text-red-700 bg-red-100 rounded-lg"></div>
                        <div class="space-y-4">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div><label for="manual-test-title" class="font-semibold">Name of Assignment</label><input type="text" id="manual-test-title" class="w-full p-2 border rounded-md mt-1" required></div>
                                <div>
                                    <label for="manual-release-scores" class="font-semibold">Release Scores</label>
                                    <select id="manual-release-scores" class="w-full p-2 border rounded-md mt-1">
                                        <option value="immediate">Immediately</option>
                                        <option value="manual">Manually, after review</option>
                                    </select>
                                </div>
                            </div>
                             <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div><label for="manual-attempts" class="font-semibold">Attempts Allowed</label><select id="manual-attempts" class="w-full p-2 border rounded-md mt-1"><option value="1">One</option><option value="unlimited">Unlimited</option></select></div>
                                <div><label for="manual-test-timer" class="font-semibold">Time Limit (minutes)</label><input type="number" id="manual-test-timer" value="0" min="0" class="w-full p-2 border rounded-md mt-1" placeholder="0 for no timer"></div>
                             </div>
                             <div class="mt-2">
                                <label class="flex items-center">
                                    <input type="checkbox" id="manual-enable-proctoring" class="h-4 w-4 text-indigo-600 focus:ring-indigo-500 border-gray-300 rounded">
                                    <span class="ml-3 font-semibold text-gray-700">Enable Full-Screen Monitoring</span>
                                </label>
                            </div>
                        </div>
                        <hr class="my-6">
                        <div id="manual-questions-container" class="space-y-6"></div>
                        <div class="mt-6 flex justify-between">
                            <button id="add-question-btn" class="bg-gray-200 text-gray-800 font-semibold py-2 px-4 rounded-lg hover:bg-gray-300 transition">+ Add Question</button>
                            <button id="save-manual-test-btn" class="bg-indigo-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-indigo-700 transition">Save Assignment</button>
                        </div>
                    </div>

                    <!-- Test Taking View -->
                    <div id="test-taking-view" class="hidden bg-white p-8 rounded-xl shadow-md">
                        <div id="test-timer-display" class="text-right font-bold text-lg mb-4"></div>
                        <div id="question-container"></div>
                        <div id="test-navigation" class="mt-6 flex justify-between items-center"></div>
                    </div>

                    <!-- Student Test Results View -->
                    <div id="test-results-view" class="hidden text-center bg-white p-8 rounded-xl shadow-md">
                        <h2 class="text-3xl font-bold mb-4">Submission Received!</h2>
                        <div id="test-result-content">
                            <!-- Content will be injected by JS -->
                        </div>
                        <button id="back-to-student-assessment-dashboard-btn" class="mt-6 bg-indigo-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-indigo-700">Back to Dashboard</button>
                    </div>

                     <!-- Teacher Test Results Dashboard -->
                    <div id="test-results-dashboard-view" class="hidden bg-white p-8 rounded-xl shadow-md">
                        <!-- Content will be injected by JS -->
                    </div>
                     <!-- Student Review View -->
                    <div id="student-review-view" class="hidden bg-white p-8 rounded-xl shadow-md">
                         <!-- Content will be injected by JS -->
                    </div>
                </div>
            </div>
        </div>

        <!-- Live Activity Modal -->
        <div id="live-activity-modal" class="fixed inset-0 bg-gray-800 bg-opacity-75 flex items-center justify-center p-4">
            <div class="bg-white rounded-xl shadow-2xl w-full max-w-6xl h-[90vh] flex flex-col">
                <div class="p-4 border-b flex justify-between items-center">
                    <h2 class="text-2xl font-bold">Live Student Activity</h2>
                    <button id="close-live-activity-btn" class="text-gray-500 hover:text-gray-800 text-3xl leading-none">&times;</button>
                </div>
                <div id="live-activity-content" class="p-6 overflow-y-auto bg-gray-50">
                     <!-- Live status grid will be injected here -->
                </div>
            </div>
        </div>
        
        <!-- Generic Confirmation Modal -->
        <div id="confirmation-modal" class="fixed inset-0 bg-gray-800 bg-opacity-75 flex items-center justify-center p-4">
            <div class="bg-white rounded-xl shadow-2xl w-full max-w-lg p-8 text-center">
                <h2 id="confirmation-title" class="text-2xl font-bold mb-4">Attention</h2>
                <p id="confirmation-message" class="text-gray-600 mb-8"></p>
                <div class="flex justify-center gap-4">
                    <button id="confirmation-cancel-btn" class="bg-gray-200 text-gray-800 font-semibold py-2 px-6 rounded-lg hover:bg-gray-300">Cancel</button>
                    <button id="confirmation-ok-btn" class="bg-indigo-600 text-white font-semibold py-2 px-6 rounded-lg hover:bg-indigo-700">OK</button>
                </div>
            </div>
        </div>


        <!-- Add User Modal -->
        <div id="add-user-modal" class="fixed inset-0 bg-gray-800 bg-opacity-75 flex items-center justify-center p-4">
            <div class="bg-white rounded-xl shadow-2xl w-full max-w-md">
                <div class="p-4 border-b flex justify-between items-center">
                    <h2 class="text-2xl font-bold">Add New User</h2>
                    <button id="close-add-user-modal-btn" class="text-gray-500 hover:text-gray-800 text-3xl leading-none">&times;</button>
                </div>
                <form id="add-user-form" class="p-6 space-y-4">
                    <div id="add-user-error" class="hidden p-3 mb-4 text-sm text-red-700 bg-red-100 rounded-lg"></div>
                    <div>
                        <label for="add-user-firstName" class="block text-sm font-medium text-gray-700">First Name</label>
                        <input type="text" id="add-user-firstName" class="w-full mt-1 p-2 border rounded-md" required>
                    </div>
                    <div>
                        <label for="add-user-lastName" class="block text-sm font-medium text-gray-700">Last Name</label>
                        <input type="text" id="add-user-lastName" class="w-full mt-1 p-2 border rounded-md" required>
                    </div>
                    <div>
                        <label for="add-user-number" class="block text-sm font-medium text-gray-700">User Number</label>
                        <input type="number" id="add-user-number" class="w-full mt-1 p-2 border rounded-md" placeholder="e.g., 123456" required>
                    </div>
                    <div>
                        <label for="add-user-role" class="block text-sm font-medium text-gray-700">Role</label>
                        <select id="add-user-role" class="w-full mt-1 p-2 border rounded-md" required>
                            <option value="">Select a role...</option>
                            <option value="teacher">Teacher</option>
                            <option value="student">Student</option>
                        </select>
                    </div>
                    <div id="role-specific-fields">
                        <!-- Teacher fields -->
                        <div id="teacher-fields" class="hidden">
                            <label for="add-user-subjects" class="block text-sm font-medium text-gray-700">Subjects Taught (comma-separated)</label>
                            <input type="text" id="add-user-subjects" class="w-full mt-1 p-2 border rounded-md">
                        </div>
                        <!-- Student fields -->
                        <div id="student-fields" class="hidden space-y-4">
                            <div>
                                 <label class="block text-sm font-medium text-gray-700">Assign to Teacher(s) and specify Class Name</label>
                                 <div id="assign-teacher-list" class="mt-2 max-h-40 overflow-y-auto border rounded-md p-2 space-y-2">
                                    <!-- Checkboxes and inputs will be injected here -->
                                 </div>
                            </div>
                        </div>
                    </div>
                    <div class="pt-4">
                        <button type="submit" class="w-full bg-green-600 text-white font-semibold py-3 px-4 rounded-lg hover:bg-green-700 transition">Create User</button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Edit User Modal -->
        <div id="edit-user-modal" class="fixed inset-0 bg-gray-800 bg-opacity-75 flex items-center justify-center p-4 hidden">
            <div class="bg-white rounded-xl shadow-2xl w-full max-w-md">
                <div class="p-4 border-b flex justify-between items-center">
                    <h2 class="text-2xl font-bold">Edit Student</h2>
                    <button id="close-edit-user-modal-btn" class="text-gray-500 hover:text-gray-800 text-3xl leading-none">&times;</button>
                </div>
                <form id="edit-user-form" class="p-6 space-y-4">
                    <input type="hidden" id="edit-user-id">
                    <div id="edit-user-error" class="hidden p-3 mb-4 text-sm text-red-700 bg-red-100 rounded-lg"></div>
                    <div>
                        <label for="edit-user-firstName" class="block text-sm font-medium text-gray-700">First Name</label>
                        <input type="text" id="edit-user-firstName" class="w-full mt-1 p-2 border rounded-md" required>
                    </div>
                    <div>
                        <label for="edit-user-lastName" class="block text-sm font-medium text-gray-700">Last Name</label>
                        <input type="text" id="edit-user-lastName" class="w-full mt-1 p-2 border rounded-md" required>
                    </div>
                    <div>
                        <label for="edit-user-number" class="block text-sm font-medium text-gray-700">User Number</label>
                        <input type="number" id="edit-user-number" class="w-full mt-1 p-2 border rounded-md" required>
                    </div>
                    <div>
                         <label class="block text-sm font-medium text-gray-700">Assign to Teacher(s) and specify Class Name</label>
                         <div id="edit-assign-teacher-list" class="mt-2 max-h-40 overflow-y-auto border rounded-md p-2 space-y-2">
                            <!-- Checkboxes and inputs will be injected here -->
                         </div>
                    </div>
                    <div class="pt-4">
                        <button type="submit" class="w-full bg-indigo-600 text-white font-semibold py-3 px-4 rounded-lg hover:bg-indigo-700 transition">Save Changes</button>
                    </div>
                </form>
            </div>
        </div>
       
        <!-- Student Details Modal -->
        <div id="student-details-modal" class="fixed inset-0 bg-gray-800 bg-opacity-75 flex items-center justify-center p-4">
            <div class="bg-white rounded-xl shadow-2xl w-full max-w-4xl h-[90vh] flex flex-col">
                <div class="p-4 border-b flex justify-between items-center">
                    <h2 id="student-details-title" class="text-2xl font-bold">Student Details</h2>
                    <button id="close-student-details-btn" class="text-gray-500 hover:text-gray-800 text-3xl leading-none">&times;</button>
                </div>
                <div id="student-details-content" class="p-6 overflow-y-auto bg-gray-50">
                    <!-- Student details will be injected here -->
                </div>
            </div>
        </div>

        <!-- Grade Details Modal -->
        <div id="grade-details-modal" class="fixed inset-0 bg-gray-800 bg-opacity-75 flex items-center justify-center p-4">
            <div class="bg-white rounded-xl shadow-2xl w-full max-w-md">
                <div class="p-4 border-b flex justify-between items-center">
                    <h2 id="grade-details-title" class="text-2xl font-bold">Edit Grade</h2>
                    <button id="close-grade-details-btn" class="text-gray-500 hover:text-gray-800 text-3xl leading-none">&times;</button>
                </div>
                <form id="grade-details-form" class="p-6 space-y-4">
                    <input type="hidden" id="grade-details-student-id">
                    <input type="hidden" id="grade-details-assignment-id">
                    <div>
                        <label for="grade-details-score" class="block text-sm font-medium text-gray-700">Score</label>
                        <input type="number" id="grade-details-score" class="w-full mt-1 p-2 border rounded-md">
                    </div>
                    <div>
                        <label for="grade-details-status" class="block text-sm font-medium text-gray-700">Status</label>
                        <select id="grade-details-status" class="w-full mt-1 p-2 border rounded-md">
                            <option value="">None</option>
                            <option value="Missing">Missing</option>
                            <option value="Late">Late</option>
                            <option value="Excused">Excused</option>
                            <option value="Incomplete">Incomplete</option>
                        </select>
                    </div>
                    <div>
                        <label for="grade-details-comment" class="block text-sm font-medium text-gray-700">Comment (visible to student)</label>
                        <textarea id="grade-details-comment" rows="3" class="w-full mt-1 p-2 border rounded-md"></textarea>
                    </div>
                    <div class="pt-4 flex justify-end gap-3">
                        <button type="button" id="delete-grade-btn" class="bg-red-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-red-700 transition">Delete Grade</button>
                        <button type="submit" class="bg-indigo-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-indigo-700 transition">Save Changes</button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Assignment Details Modal -->
        <div id="assignment-details-modal" class="fixed inset-0 bg-gray-800 bg-opacity-75 flex items-center justify-center p-4">
            <div class="bg-white rounded-xl shadow-2xl w-full max-w-4xl h-[90vh] flex flex-col">
                <div class="p-4 border-b flex justify-between items-center">
                    <h2 id="assignment-details-title" class="text-2xl font-bold">Assignment Details</h2>
                    <button id="close-assignment-details-btn" class="text-gray-500 hover:text-gray-800 text-3xl leading-none">&times;</button>
                </div>
                <div class="p-6 overflow-y-auto">
                    <div id="assignment-details-stats" class="grid grid-cols-3 gap-4 mb-6 text-center">
                        <!-- Stats injected here -->
                    </div>
                    <div id="assignment-details-student-list">
                        <!-- Student list injected here -->
                    </div>
                </div>
            </div>
        </div>

        <!-- Export Grades Modal -->
        <div id="export-grades-modal" class="fixed inset-0 bg-gray-800 bg-opacity-75 flex items-center justify-center p-4 hidden">
            <div class="bg-white rounded-xl shadow-2xl w-full max-w-md">
                <div class="p-4 border-b flex justify-between items-center">
                    <h2 id="export-grades-title" class="text-2xl font-bold">Export to Gradebook</h2>
                    <button id="close-export-grades-btn" class="text-gray-500 hover:text-gray-800 text-3xl leading-none">&times;</button>
                </div>
                <form id="export-grades-form" class="p-6 space-y-4">
                    <input type="hidden" id="export-assessment-id">
                    <div>
                        <label for="export-category-select" class="block text-sm font-medium text-gray-700 mb-2">Select a Gradebook Category</label>
                        <select id="export-category-select" class="w-full mt-1 p-2 border rounded-md" required>
                            <!-- Categories will be populated by JS -->
                        </select>
                         <p id="export-category-error" class="text-red-600 text-sm mt-1 hidden">Please create a category in the gradebook first.</p>
                    </div>
                    <div id="export-status-message" class="text-center text-gray-600"></div>
                    <div class="pt-4 flex justify-end">
                        <button type="submit" id="sync-to-gradebook-btn" class="bg-indigo-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-indigo-700 transition">Sync to Gradebook</button>
                    </div>
                </form>
            </div>
        </div>

    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, serverTimestamp, query, onSnapshot, doc, deleteDoc, getDocs, getDoc, setDoc, where, updateDoc, orderBy } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- Config & State ---
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'resource-hub-default';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        let auth, db, userRole, userData = {}, conversationState = 0;
        let gradebookState = { students: [], categories: [], assignments: [], grades: {}, attendance: {} };
        let adminState = { teachers: [], students: [] };
        let assessmentState = { currentTest: null, currentQuestionIndex: 0, userAnswers: {}, timerInterval: null, proctoringFlags: [], testSubmitted: false };
        let unsubscribers = [];
        const ADMIN_CODE = "ADMIN123";
        const TEACHER_CODE = "TEACHER123";
        const STUDENT_CODE = "STUDENT123";

        // --- DB Path Helpers ---
        const publicPath = () => `/artifacts/${appId}/public/data`;
        const assessmentPath = () => `/artifacts/${appId}/public/data/assessments`;

        // --- DOM Elements ---
        const roleSelection = document.getElementById('role-selection');
        const chatbotContainer = document.getElementById('chatbot-container');
        const chatbotTitle = document.getElementById('chatbot-title');
        const chatbotMessages = document.getElementById('chatbot-messages');
        const chatbotTyping = document.getElementById('chatbot-typing');
        const chatbotForm = document.getElementById('chatbot-form');
        const chatbotInput = document.getElementById('chatbot-input');
        const appContainer = document.getElementById('app-container');
        const userDisplay = document.getElementById('user-display');
        const loader = document.getElementById('loader');
        const teacherDashboard = document.getElementById('teacher-dashboard');
        const studentDashboard = document.getElementById('student-dashboard');
        const logoutBtn = document.getElementById('logout-btn');
        const gradebookModal = document.getElementById('gradebook-modal');
        const gradebookTitle = document.getElementById('gradebook-title');
        const openTeacherVueBtn = document.getElementById('open-teachervue-btn');
        const closeGradebookBtn = document.getElementById('close-gradebook-btn');
        const teacherGradebookView = document.getElementById('teacher-gradebook-view');
        const studentGradebookListView = document.getElementById('student-gradebook-list-view');
        const studentGradebookDetailView = document.getElementById('student-gradebook-detail-view');
        const aiPromptForm = document.getElementById('ai-prompt-form');
        const aiAssistantModal = document.getElementById('ai-assistant-modal');
        const closeAiModalBtn = document.getElementById('close-ai-modal-btn');
        const aiResponseContainer = document.getElementById('ai-response-container');
        const aiLoader = document.getElementById('ai-loader');
        const assessmentModal = document.getElementById('assessment-modal');
        const openAssessmentBtn = document.getElementById('open-assessment-btn');
        const closeAssessmentBtn = document.getElementById('close-assessment-btn');
        const teacherAssessmentDashboard = document.getElementById('teacher-assessment-dashboard');
        const studentAssessmentDashboard = document.getElementById('student-assessment-dashboard');
        const aiAssessmentCreator = document.getElementById('ai-assessment-creator');
        const manualAssessmentCreator = document.getElementById('manual-assessment-creator');
        const adminDashboard = document.getElementById('admin-dashboard');
        const adminBtn = document.getElementById('admin-btn');
        const teacherBtn = document.getElementById('teacher-btn');
        const studentBtn = document.getElementById('student-btn');
        const addUserBtn = document.getElementById('add-user-btn');
        const addUserModal = document.getElementById('add-user-modal');
        const closeAddUserModalBtn = document.getElementById('close-add-user-modal-btn');
        const addUserForm = document.getElementById('add-user-form');
        const addUserRole = document.getElementById('add-user-role');
        const teacherFields = document.getElementById('teacher-fields');
        const studentFields = document.getElementById('student-fields');
        const editUserModal = document.getElementById('edit-user-modal');
        const closeEditUserModalBtn = document.getElementById('close-edit-user-modal-btn');
        const editUserForm = document.getElementById('edit-user-form');
        const studentDetailsModal = document.getElementById('student-details-modal');
        const closeStudentDetailsBtn = document.getElementById('close-student-details-btn');
        const gradeDetailsModal = document.getElementById('grade-details-modal');
        const closeGradeDetailsBtn = document.getElementById('close-grade-details-btn');
        const gradeDetailsForm = document.getElementById('grade-details-form');
        const assignmentDetailsModal = document.getElementById('assignment-details-modal');
        const closeAssignmentDetailsBtn = document.getElementById('close-assignment-details-btn');
        const attendanceModal = document.getElementById('attendance-modal');
        const scheduleManagerModal = document.getElementById('schedule-manager-modal');
        const confirmationModal = document.getElementById('confirmation-modal');
        const liveActivityModal = document.getElementById('live-activity-modal');
       
        // --- Chatbot Logic ---
        const scrollChat = () => { chatbotMessages.scrollTop = chatbotMessages.scrollHeight; };
        const showTyping = (show = true) => { chatbotTyping.style.display = show ? 'block' : 'none'; };
        function addBotMessage(text) { chatbotMessages.innerHTML += `<div class="chat-message chat-bubble-bot p-3 rounded-lg max-w-xs">${text}</div>`; scrollChat(); }
        function addUserMessage(text) { chatbotMessages.innerHTML += `<div class="chat-message chat-bubble-user p-3 rounded-lg max-w-xs">${text}</div>`; scrollChat(); }
       
        function startChatbot(role) {
            userRole = role;
            chatbotTitle.textContent = `${role.charAt(0).toUpperCase() + role.slice(1)} Login`;
            chatbotMessages.innerHTML = '';
            roleSelection.classList.add('hidden');
            chatbotContainer.classList.remove('hidden');
           
            // Only admins can create new accounts. Teachers and students go straight to login.
            if (role === 'admin') {
                conversationState = 0; // Admin can choose 'new' or 'returning'
            } else {
                conversationState = 10; // Teachers/Students go straight to login
            }
            setTimeout(() => askQuestion(), 500);
        }

        function askQuestion() {
            showTyping();
            setTimeout(() => {
                let question = '';
                if (conversationState === 0) { // Only for Admin now
                    question = "Are you a <b>new</b> or a <b>returning</b> user?";
                } else if (conversationState === 1) { // Admin new user setup
                    question = `Understood. To create a new ${userRole} account, please enter the registration code.`;
                } else if (conversationState === 2) { // Admin new user setup
                    question = "Great! Let's get you set up. What is your first name?";
                } else if (conversationState === 3) { // Admin new user setup
                    question = `Got it, ${userData.firstName}. And your last name?`;
                } else if (conversationState === 10) { // Login for ALL roles
                    if (userRole === 'admin') {
                         question = "Welcome back. Please enter your Full Name (e.g. Jane Doe) or your User Number to log in.";
                    } else {
                         question = "Welcome. Please enter your <b>Full Name</b> or <b>User Number</b> to log in.";
                    }
                }
               
                showTyping(false);
                if (question) { addBotMessage(question); chatbotInput.focus(); }
            }, 1000);
        }

        function signInAndShowApp(userToSignIn) {
            addBotMessage(`Welcome back, ${userToSignIn.firstName}! Logging you in...`);
            localStorage.setItem('learningSpaceUser', JSON.stringify(userToSignIn));
            setTimeout(() => {
                chatbotContainer.classList.add('hidden');
                showApp(userToSignIn);
            }, 1500);
        }
       
        function toTitleCase(str) {
            if (!str) return '';
            return str.replace(
                /\w\S*/g,
                (txt) => txt.charAt(0).toUpperCase() + txt.substr(1).toLowerCase()
            );
        }

        async function loginUser(loginIdentifier, expectedRole) {
            const allUsersRef = collection(db, `${publicPath()}/all_users`);
            const identifier = loginIdentifier.trim();
            const isNumber = !isNaN(identifier) && !isNaN(parseFloat(identifier));
           
            try {
                const querySnapshot = await getDocs(allUsersRef);
                const allUsers = querySnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

                let foundUser = null;

                if (isNumber) {
                    const parsedUserNumber = parseInt(identifier);
                    foundUser = allUsers.find(user => user.role === expectedRole && user.userNumber === parsedUserNumber);
                } else {
                    const loginNameLower = identifier.toLowerCase();
                    foundUser = allUsers.find(user =>
                        user.role === expectedRole &&
                        (((user.firstName || '') + ' ' + (user.lastName || '')).trim().toLowerCase() === loginNameLower)
                    );
                }

                if (foundUser) {
                    signInAndShowApp(foundUser);
                } else {
                    if (allUsers.length === 0) {
                        addBotMessage("I couldn't find any users in the database. Please log in as an Admin to create a new user account.");
                    } else {
                        const roleExists = allUsers.some(user => user.role === expectedRole);
                        if (roleExists) {
                             addBotMessage("We couldn't find an account matching that name/number for your role. Please check your spelling and try again.");
                        } else {
                             addBotMessage("I found users in the database, but none with that specific role. Please ensure the account was created correctly.");
                        }
                    }
                }
            } catch (error) {
                console.error("Login error:", error);
                addBotMessage('An error occurred while trying to log in. Please check your connection and try again.');
            }
        }

        async function generateCredentials() {
             const userNumber = Math.floor(100000 + Math.random() * 900000);
             addBotMessage(`All set, ${userData.firstName}! Your new User Number is <b>${userNumber}</b>. Please save it. I'll log you in now.`);
             const userToSave = { ...userData, userNumber, role: userRole, createdAt: serverTimestamp() };
             
             const newUserRef = await addDoc(collection(db, `${publicPath()}/all_users`), userToSave);
             
             signInAndShowApp({ ...userToSave, id: newUserRef.id });
        }


        // --- App UI & Main Logic ---
        function cleanupListeners() { unsubscribers.forEach(unsub => unsub()); unsubscribers = []; }
        function showApp(currentUser) {
            roleSelection.classList.add('hidden');
            appContainer.classList.remove('hidden');
            loader.style.display = 'none';
            userRole = currentUser.role;
            userData = currentUser;
            userDisplay.innerHTML = `Account Owner: <strong>${userData.firstName} ${userData.lastName}</strong><br><span class="text-sm text-gray-500">Role: ${userRole.charAt(0).toUpperCase() + userRole.slice(1)} | User Number: ${userData.userNumber}</span>`;
           
            cleanupListeners();
            teacherDashboard.classList.add('hidden');
            studentDashboard.classList.add('hidden');
            adminDashboard.classList.add('hidden');

            if (userRole === 'teacher') {
                teacherDashboard.classList.remove('hidden');
                setupTeacherListeners();
            } else if (userRole === 'student') {
                studentDashboard.classList.remove('hidden');
                setupStudentListeners();
            } else if (userRole === 'admin') {
                adminDashboard.classList.remove('hidden');
                setupAdminListeners();
            }
        }

        // --- Gradebook Logic ---
        function openGradebook(view, teacherId = null, className = null) {
            gradebookModal.style.display = 'flex';
            teacherGradebookView.classList.add('hidden');
            studentGradebookListView.classList.add('hidden');
            studentGradebookDetailView.classList.add('hidden');

            if (view === 'teacher') {
                gradebookTitle.textContent = 'TeacherVUE';
                teacherGradebookView.classList.remove('hidden');
                renderTeacherGradebook();
            } else if (view === 'student_list') {
                gradebookTitle.textContent = 'StudentVUE';
                studentGradebookListView.classList.remove('hidden');
                renderStudentMultiClassView();
            } else if (view === 'student_detail') {
                gradebookTitle.textContent = 'StudentVUE';
                studentGradebookDetailView.classList.remove('hidden');
                renderStudentGradebookDetailView(teacherId, className);
            }
        }
        function closeGradebook() { gradebookModal.style.display = 'none'; }
       
        function getGradeColor(grade) {
            const numGrade = parseFloat(grade);
            if (isNaN(numGrade)) return 'text-gray-500';
            if (numGrade >= 90) return 'text-green-600';
            if (numGrade >= 80) return 'text-blue-600';
            if (numGrade >= 70) return 'text-yellow-600';
            if (numGrade >= 60) return 'text-orange-600';
            return 'text-red-600';
        }

        function calculateFinalGrade(studentId, categories, assignments, grades) {
            let totalWeightedScore = 0;
            let totalWeightsUsed = 0;
            categories.forEach(cat => {
                const categoryAssignments = assignments.filter(a => a.categoryId === cat.id);
                if (!categoryAssignments.length) return;

                let studentTotalPoints = 0;
                let categoryTotalPoints = 0;

                categoryAssignments.forEach(assign => {
                    const gradeKey = `${studentId}_${assign.id}`;
                    const gradeData = grades[gradeKey];
                    if (gradeData && gradeData.score !== undefined && gradeData.score !== null && gradeData.score !== '' && gradeData.status !== 'Excused') {
                        studentTotalPoints += parseFloat(gradeData.score);
                        categoryTotalPoints += parseFloat(assign.points);
                    }
                });

                if (categoryTotalPoints > 0) {
                    const categoryAverage = (studentTotalPoints / categoryTotalPoints);
                    totalWeightedScore += categoryAverage * (cat.weight);
                    totalWeightsUsed += parseFloat(cat.weight);
                }
            });

            if (totalWeightsUsed === 0) return { percent: 'N/A', letter: '' };
            const finalPercentage = (totalWeightedScore / totalWeightsUsed) * 100;

            let letter = 'F';
            if (finalPercentage >= 90) letter = 'A';
            else if (finalPercentage >= 80) letter = 'B';
            else if (finalPercentage >= 70) letter = 'C';
            else if (finalPercentage >= 60) letter = 'D';

            return { percent: finalPercentage.toFixed(2), letter: letter };
        }
       
        // --- Teacher UI Rendering ---
        function renderTeacherGradebook() {
            renderCategories();
            renderAssignmentHeaders();
            renderGradebookBody();
            calculateAndDisplayAverages();
        }
        function renderCategories() {
            const list = document.getElementById('category-list');
            const totalWeightEl = document.getElementById('total-weight');
            const assignmentCategorySelect = document.getElementById('assignment-category');
           
            let listHtml = '';
            let totalWeight = 0;
           
            gradebookState.categories.forEach(cat => {
                listHtml += `<div class="flex justify-between items-center p-1 bg-white rounded"><span>${cat.name} (${cat.weight}%)</span><button data-id="${cat.id}" class="text-red-500 font-bold delete-category-btn px-2">x</button></div>`;
                totalWeight += parseInt(cat.weight) || 0;
            });

            list.innerHTML = listHtml;
            totalWeightEl.textContent = `Total Weight: ${totalWeight}%`;
            totalWeightEl.style.color = totalWeight !== 100 ? '#DC2626' : '#16A34A';
            assignmentCategorySelect.innerHTML = gradebookState.categories.map(c => `<option value="${c.id}">${c.name}</option>`).join('') || '<option disabled>Please create a category first</option>';
        }
        function renderAssignmentHeaders() {
            document.getElementById('assignment-headers').innerHTML = gradebookState.assignments.map(assign =>
                `<th class="px-4 py-3 text-center text-xs font-bold text-gray-600 uppercase tracking-wider relative group">
                    <a href="#" class="hover:underline assignment-details-link" data-assignment-id="${assign.id}">${assign.name}</a>
                    <div class="text-gray-400 font-normal normal-case">${assign.points} pts</div>
                    <button data-id="${assign.id}" class="absolute top-0 right-0 text-red-500 opacity-0 group-hover:opacity-100 transition-opacity delete-assignment-btn">x</button>
                </th>`
            ).join('');
        }
        function renderGradebookBody() {
            const body = document.getElementById('gradebook-body');
            body.innerHTML = '';
            const noStudentsMsg = document.getElementById('no-students-msg');

            if(gradebookState.students.length === 0) {
                noStudentsMsg.classList.remove('hidden');
                return;
            }
            noStudentsMsg.classList.add('hidden');

            gradebookState.students.forEach(student => {
                const assignmentsHtml = gradebookState.assignments.map(assign => {
                    const gradeData = gradebookState.grades[`${student.id}_${assign.id}`] || {};
                    const score = gradeData.score ?? '';
                    const statusClass = gradeData.status ? `status-${gradeData.status.toLowerCase()}` : '';
                    const hasComment = gradeData.comment && gradeData.comment.trim() !== '';

                    let display = score;
                    if(gradeData.status === 'Missing') display = 'M';
                    if(gradeData.status === 'Excused') display = 'Exc';
                    if(gradeData.status === 'Incomplete') display = 'Inc';

                    return `<td class="p-2 text-center grade-cell ${statusClass}" data-student-id="${student.id}" data-assignment-id="${assign.id}">
                                ${display}
                                ${hasComment ? '<div class="comment-indicator"></div>' : ''}
                            </td>`;
                }).join('');
                const finalGrade = calculateFinalGrade(student.id, gradebookState.categories, gradebookState.assignments, gradebookState.grades);
                const gradeColor = getGradeColor(parseFloat(finalGrade.percent));
                body.innerHTML += `<tr>
                    <td class="px-4 py-2 whitespace-nowrap sticky left-0 bg-white hover:bg-gray-50 student-name-cell" data-student-id="${student.id}">${student.firstName} ${student.lastName}</td>
                    ${assignmentsHtml}
                    <td class="px-4 py-2 whitespace-nowrap font-bold text-center ${gradeColor}">
                        <div>${finalGrade.percent === 'N/A' ? 'N/A' : finalGrade.percent + '%'}</div>
                        <div class="text-sm font-medium">${finalGrade.letter}</div>
                    </td>
                </tr>`;
            });
        }
       
        function calculateAndDisplayAverages() {
            const footer = document.getElementById('gradebook-footer');
            if (gradebookState.students.length === 0) {
                footer.innerHTML = '';
                return;
            }

            let assignmentAveragesHtml = '';
            gradebookState.assignments.forEach(assign => {
                let total = 0;
                let count = 0;
                gradebookState.students.forEach(student => {
                    const gradeData = gradebookState.grades[`${student.id}_${assign.id}`];
                    if (gradeData && gradeData.score !== null && gradeData.score !== '' && gradeData.status !== 'Excused') {
                        total += parseFloat(gradeData.score);
                        count++;
                    }
                });
                const average = count > 0 ? (total / count).toFixed(1) : 'N/A';
                assignmentAveragesHtml += `<td class="px-4 py-2 text-center font-bold">${average}</td>`;
            });

            let finalGradeTotal = 0;
            let finalGradeCount = 0;
            gradebookState.students.forEach(student => {
                const finalGrade = calculateFinalGrade(student.id, gradebookState.categories, gradebookState.assignments, gradebookState.grades);
                if (finalGrade.percent !== 'N/A') {
                    finalGradeTotal += parseFloat(finalGrade.percent);
                    finalGradeCount++;
                }
            });
            const finalAverage = finalGradeCount > 0 ? (finalGradeTotal / finalGradeCount).toFixed(2) + '%' : 'N/A';

            footer.innerHTML = `
                <tr>
                    <td class="px-4 py-3 text-left text-xs font-bold text-gray-600 uppercase tracking-wider sticky left-0 bg-gray-200 z-10">Class Average</td>
                    ${assignmentAveragesHtml}
                    <td class="px-4 py-3 text-center text-xs font-bold text-gray-600 uppercase tracking-wider">${finalAverage}</td>
                </tr>
            `;
        }
       
        function renderTeacherAnnouncements(announcements) {
            const container = document.getElementById('announcement-list');
            if (announcements.length === 0) {
                container.innerHTML = `<p class="text-center text-gray-500">No announcements yet.</p>`;
                return;
            }
            container.innerHTML = announcements.map(ann => `
                <div class="new-item bg-gray-50 p-3 rounded-lg border flex justify-between items-start">
                    <div>
                        <p class="text-gray-800">${ann.text.replace(/\n/g, '<br>')}</p>
                        <p class="text-xs text-gray-400 mt-2">${ann.createdAt ? new Date(ann.createdAt.seconds * 1000).toLocaleString() : 'Just now'}</p>
                    </div>
                    <button data-id="${ann.id}" class="delete-announcement-btn text-red-500 hover:text-red-700 font-bold text-lg">&times;</button>
                </div>
            `).join('');
        }

       
        // --- Student UI Rendering ---
        async function renderStudentMultiClassView() {
            studentGradebookListView.innerHTML = `<div class="text-center p-8"><svg class="animate-spin h-8 w-8 text-indigo-600 mx-auto" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg><p class="mt-2">Loading your classes...</p></div>`;
            const studentId = userData.id;
            const rosterQuery = query(collection(db, `${publicPath()}/roster_entries`), where("studentId", "==", studentId));
            const rosterSnap = await getDocs(rosterQuery);

            if (rosterSnap.empty) {
                studentGradebookListView.innerHTML = `<p class="text-center p-8">You are not enrolled in any classes.</p>`;
                return;
            }

            let classCardsHtml = '';
            for (const rosterDoc of rosterSnap.docs) {
                const rosterData = rosterDoc.data();
                const teacherId = rosterData.teacherId;
               
                const teacherSnap = await getDoc(doc(db, `${publicPath()}/all_users`, teacherId));
                const teacherData = teacherSnap.exists() ? teacherSnap.data() : {firstName: 'N/A', lastName: ''};

                const categoriesSnap = await getDocs(collection(db, `${publicPath()}/class_materials/${teacherId}/categories`));
                const assignmentsSnap = await getDocs(collection(db, `${publicPath()}/class_materials/${teacherId}/assignments`));
                const gradesSnap = await getDocs(query(collection(db, `${publicPath()}/grades`), where("studentId", "==", studentId), where("teacherId", "==", teacherId)));

                const categories = categoriesSnap.docs.map(d => ({ id: d.id, ...d.data() }));
                const assignments = assignmentsSnap.docs.map(d => ({ id: d.id, ...d.data() }));
                const grades = {};
                gradesSnap.docs.forEach(d => { grades[`${studentId}_${d.data().assignmentId}`] = d.data(); });

                const finalGrade = calculateFinalGrade(studentId, categories, assignments, grades);
                const missingAssignments = assignments.filter(a => !grades[`${studentId}_${a.id}`]).length;

                classCardsHtml += `
                    <div class="bg-white rounded-lg shadow-sm border mb-4 cursor-pointer hover:shadow-md transition class-card" data-teacher-id="${teacherId}" data-class-name="${rosterData.className}">
                        <div class="p-4 border-b flex justify-between items-center">
                            <h3 class="text-xl font-bold text-indigo-700">${rosterData.className}</h3>
                            <div class="text-right text-sm text-gray-600">
                                <span>${teacherData.firstName} ${teacherData.lastName}</span>
                            </div>
                        </div>
                        <div class="p-4 flex justify-between items-center">
                            <div class="text-sm font-semibold text-blue-600">Semester Average</div>
                            <div class="text-4xl font-bold ${getGradeColor(finalGrade.percent)}">${finalGrade.percent === 'N/A' ? 'N/A' : Math.round(finalGrade.percent)}</div>
                            <div class="text-sm text-gray-500">${missingAssignments} Missing Assignments</div>
                        </div>
                    </div>
                `;
            }

            studentGradebookListView.innerHTML = classCardsHtml;
        }

        async function renderStudentGradebookDetailView(teacherId, className) {
             studentGradebookDetailView.innerHTML = `<div class="text-center p-8"><svg class="animate-spin h-8 w-8 text-indigo-600 mx-auto" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg><p class="mt-2">Loading class details...</p></div>`;
             
             const studentId = userData.id;

             // Fetch all necessary data
             const teacherSnap = await getDoc(doc(db, `${publicPath()}/all_users`, teacherId));
             const teacherData = teacherSnap.exists() ? teacherSnap.data() : { firstName: 'Teacher', lastName: 'Name' };
             const categoriesSnap = await getDocs(collection(db, `${publicPath()}/class_materials/${teacherId}/categories`));
             const assignmentsSnap = await getDocs(collection(db, `${publicPath()}/class_materials/${teacherId}/assignments`));
             const gradesSnap = await getDocs(query(collection(db, `${publicPath()}/grades`), where("studentId", "==", studentId), where("teacherId", "==", teacherId)));

             const categories = categoriesSnap.docs.map(d => ({ id: d.id, ...d.data() }));
             const assignments = assignmentsSnap.docs.map(d => ({ id: d.id, ...d.data() })).sort((a,b) => new Date(a.dueDate) - new Date(b.dueDate));
             const grades = {};
             gradesSnap.docs.forEach(d => { grades[`${studentId}_${d.data().assignmentId}`] = d.data(); });
             const finalGrade = calculateFinalGrade(studentId, categories, assignments, grades);

             // Store the data on the element for the event listener to use
             studentGradebookDetailView.dataset.gradeData = JSON.stringify({ studentId, categories, assignments, grades });

             // Calculate stats for the header
            const missingAssignments = assignments.filter(a => {
                const grade = grades[`${studentId}_${a.id}`];
                return !grade || (grade.score == null && grade.status !== 'Excused');
            }).length;
             const now = new Date();
             const nextWeek = new Date();
             nextWeek.setDate(now.getDate() + 7);
             const upcomingAssignments = assignments.filter(a => {
                const dueDate = new Date(a.dueDate);
                return dueDate >= now && dueDate <= nextWeek && !grades[`${studentId}_${a.id}`];
             }).length;

            // --- Inner function to render the timeline based on filtered assignments ---
            function updateTimelineView(assignmentsToRender) {
                const timelineContainer = document.getElementById('timeline-container');
                const outlineContainer = document.getElementById('outline-container');
                if (!timelineContainer || !outlineContainer) return;

                if(assignmentsToRender.length === 0) {
                    timelineContainer.innerHTML = `<p class="text-center text-gray-500 py-8">No assignments match your criteria.</p>`;
                    outlineContainer.innerHTML = `<h4 class="font-bold mb-2">Outline</h4><p class="text-sm text-gray-500">No assignments to show.</p>`;
                    return;
                }
               
                const assignmentsByWeek = assignmentsToRender.reduce((acc, assignment) => {
                    const date = new Date(assignment.dueDate);
                    date.setHours(0, 0, 0, 0);
                    const firstDay = new Date(date.setDate(date.getDate() - date.getDay() + (date.getDay() === 0 ? -6 : 1))); // Monday
                    const lastDay = new Date(firstDay);
                    lastDay.setDate(lastDay.getDate() + 4); // Friday
                    const weekKey = `${firstDay.toLocaleDateString()}|${lastDay.toLocaleDateString()}`;
                    if (!acc[weekKey]) acc[weekKey] = [];
                    acc[weekKey].push(assignment);
                    return acc;
                }, {});

                let timelineHtml = '';
                let outlineHtml = '';
                const sortedWeeks = Object.keys(assignmentsByWeek).sort((a,b) => new Date(a.split('|')[0]) - new Date(b.split('|')[0]));

                sortedWeeks.forEach((weekKey, index) => {
                    const [start, end] = weekKey.split('|');
                    const weekStartDate = new Date(start);
                    const formattedStartDate = `${weekStartDate.toLocaleString('default', { month: 'short' })} ${weekStartDate.getDate()}`;
                    const weekId = `week-${index}`;

                    outlineHtml += `<a href="#${weekId}" class="block py-1 text-sm text-blue-600 hover:underline">Week ${index + 1} - ${formattedStartDate}</a>`;

                    timelineHtml += `<div id="${weekId}" class="mb-4">
                        <div class="bg-blue-600 text-white font-bold py-2 px-4 rounded-t-lg sticky top-0 z-10">
                            Week ${index + 1}: ${start} through ${end} (${assignmentsByWeek[weekKey].length} items)
                        </div>
                        <div class="border-l-2 border-gray-300 ml-4 pl-8 py-4 relative">`;

                    assignmentsByWeek[weekKey].forEach(assign => {
                        const gradeData = grades[`${studentId}_${assign.id}`] || {};
                        const score = gradeData.score ?? 'â€”';
                        const categoryName = categories.find(c => c.id === assign.categoryId)?.name || 'General';

                        timelineHtml += `<div class="mb-6 relative">
                            <div class="absolute -left-10 top-1.5 w-4 h-4 bg-white border-2 border-blue-600 rounded-full"></div>
                            <div class="bg-white p-4 rounded-lg shadow-md border hover:shadow-lg transition-shadow">
                                <div class="flex justify-between items-start">
                                    <div>
                                        <p class="text-xs text-gray-500 uppercase">${new Date(assign.dueDate).toLocaleDateString('en-US', { month: 'short', day: 'numeric' })}</p>
                                        <h4 class="font-bold text-lg text-gray-800">${assign.name}</h4>
                                        <p class="text-sm text-gray-600">${categoryName} | ${assign.points} points</p>
                                    </div>
                                    <div class="text-3xl font-bold text-right ${getGradeColor( (score / assign.points) * 100 )}">${score}</div>
                                </div>
                                <div id="what-if-container-${assign.id}" class="mt-4 pt-4 border-t border-dashed hidden">
                                     <div class="grid grid-cols-3 gap-4 text-center mb-4">
                                         <div><p class="text-xs text-gray-500">If You Score:</p><p id="what-if-score-${assign.id}" class="text-2xl font-bold">${gradeData.score ?? 0}</p></div>
                                         <div><p class="text-xs text-gray-500">Class Grade Would Be:</p><p id="what-if-grade-${assign.id}" class="text-2xl font-bold">--</p></div>
                                         <div><p class="text-xs text-gray-500">Percentage Would Be:</p><p id="what-if-percent-${assign.id}" class="text-2xl font-bold">--</p></div>
                                    </div>
                                    <input type="range" min="0" max="${assign.points}" value="${gradeData.score ?? 0}" class="w-full what-if-slider" data-assignment-id="${assign.id}">
                                    <p class="text-center text-xs text-gray-500 mt-2">Change the grade for this assignment to see how it impacts your class grade.</p>
                                </div>
                                <div class="text-right mt-2"><button class="what-if-toggle-btn text-xs text-indigo-600 font-semibold" data-assignment-id="${assign.id}">What if?</button></div>
                            </div>
                        </div>`;
                    });
                    timelineHtml += `</div></div>`;
                });

                timelineContainer.innerHTML = timelineHtml;
                outlineContainer.innerHTML = `<h4 class="font-bold mb-2">Outline</h4>${outlineHtml}`;
             }

             // --- Function to handle filtering and re-rendering ---
             function filterAndRenderTimeline() {
                const searchTerm = document.getElementById('search-assignment-input').value.toLowerCase();
                const filterStatus = document.querySelector('input[name="filter-done"]:checked').value;
               
                let filteredAssignments = assignments.filter(assign => {
                    const nameMatch = assign.name.toLowerCase().includes(searchTerm);
                    const gradeInfo = grades[`${studentId}_${assign.id}`];
                    const hasGrade = gradeInfo && gradeInfo.score != null && gradeInfo.score !== '';
                    let statusMatch = false;
                    if (filterStatus === 'all') statusMatch = true;
                    else if (filterStatus === 'done') statusMatch = hasGrade;
                    else if (filterStatus === 'not-done') statusMatch = !hasGrade;
                    return nameMatch && statusMatch;
                });
                updateTimelineView(filteredAssignments);
            }

             // --- Main view structure ---
             studentGradebookDetailView.innerHTML = `
                <div class="mb-4">
                    <button id="back-to-class-list" class="text-sm text-blue-600 hover:underline">&larr; Back to All Classes</button>
                </div>
               
                <div class="bg-white p-4 rounded-lg shadow-md mb-6 flex flex-wrap items-center justify-between gap-4">
                    <div class="flex items-center gap-4">
                        <div class="w-16 h-16 bg-indigo-100 text-indigo-600 rounded-full flex items-center justify-center text-2xl font-bold">
                            ${teacherData.firstName.charAt(0)}${teacherData.lastName.charAt(0)}
                        </div>
                        <div>
                            <p class="font-bold">${teacherData.firstName} ${teacherData.lastName}</p>
                            <p class="text-sm text-gray-600">${className}</p>
                        </div>
                    </div>
                    <div id="student-main-grade-detail" class="text-5xl font-bold ${getGradeColor(finalGrade.percent)}">
                        ${finalGrade.percent === 'N/A' ? '--' : Math.round(finalGrade.percent)}
                    </div>
                    <div class="flex gap-4 text-center">
                        <div class="p-3 bg-gray-50 rounded-lg w-32 border">
                            <p class="text-3xl font-bold">${missingAssignments}</p>
                            <p class="text-xs text-gray-500">Missing Assignments</p>
                        </div>
                        <div class="p-3 bg-gray-50 rounded-lg w-32 border">
                            <p class="text-3xl font-bold">${upcomingAssignments}</p>
                            <p class="text-xs text-gray-500">Upcoming Assignments</p>
                        </div>
                    </div>
                </div>

                <div class="bg-white p-4 rounded-lg shadow-md mb-6">
                    <div class="flex justify-between items-center">
                        <div class="w-2/5">
                            <label for="search-assignment-input" class="text-sm font-semibold text-gray-700">Search</label>
                            <input type="text" id="search-assignment-input" placeholder="Search Assignment Name" class="w-full mt-1 p-2 border rounded-md text-sm">
                        </div>
                        <div>
                            <span class="text-sm font-semibold text-gray-700">Show Done</span>
                            <div class="flex items-center gap-4 mt-2" id="filter-controls">
                                <label class="text-sm"><input type="radio" name="filter-done" value="done" class="mr-1"> Done</label>
                                <label class="text-sm"><input type="radio" name="filter-done" value="not-done" class="mr-1"> Not Done</label>
                                <label class="text-sm"><input type="radio" name="filter-done" value="all" class="mr-1" checked> All</label>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="flex">
                    <div id="timeline-container" class="w-3/4 pr-8"></div>
                    <div class="w-1/4 sticky top-28 self-start">
                         <div id="outline-container" class="bg-white p-4 rounded-lg shadow-md border"></div>
                    </div>
                </div>
             `;
           
            // Initial Render & Add Listeners
            updateTimelineView(assignments);
            document.getElementById('back-to-class-list').addEventListener('click', () => openGradebook('student_list'));
            document.getElementById('search-assignment-input').addEventListener('input', filterAndRenderTimeline);
            document.getElementById('filter-controls').addEventListener('change', filterAndRenderTimeline);

             studentGradebookDetailView.addEventListener('click', e => {
                if (e.target.matches('.what-if-toggle-btn')) {
                    const assignId = e.target.dataset.assignmentId;
                    const container = document.getElementById(`what-if-container-${assignId}`);
                    container.classList.toggle('hidden');
                    e.target.textContent = container.classList.contains('hidden') ? 'What if?' : 'Collapse';
                }
             });
        }

        function renderStudentAnnouncements(announcements) {
            const container = document.getElementById('student-announcement-list');
             if (!container) return;
            if (announcements.length === 0) {
                container.innerHTML = `<p class="text-center text-gray-500">No announcements from your teachers yet.</p>`;
                return;
            }
            container.innerHTML = announcements.map(ann => `
                 <div class="new-item bg-gray-100 p-3 rounded-lg border">
                    <p class="text-gray-800">${ann.text.replace(/\n/g, '<br>')}</p>
                    <p class="text-xs text-gray-500 mt-2">From: ${ann.teacherName} on ${ann.createdAt ? new Date(ann.createdAt.seconds * 1000).toLocaleDateString() : 'Just now'}</p>
                </div>
            `).join('');
        }

        function renderStudentSharedResources(resources) {
            const container = document.getElementById('student-shared-resources-list');
            if (!container) return;
            if (resources.length === 0) {
                container.innerHTML = `<p class="text-center text-gray-500">No resources shared by your teachers yet.</p>`;
                return;
            }
            container.innerHTML = resources.map(res => `
                 <div class="new-item bg-gray-100 p-3 rounded-lg border">
                    <a href="${res.url.startsWith('http') ? res.url : 'http://' + res.url}" target="_blank" class="font-semibold text-indigo-600 hover:underline">${res.title}</a>
                    <p class="text-xs text-gray-500 mt-1">Shared by: ${res.teacherName}</p>
                </div>
            `).join('');
        }

        // --- AI Logic ---
        async function callGemini(userQuery, systemPrompt, jsonSchema = null) {
            const apiKey = "";
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;
           
            const payload = { contents: [{ parts: [{ text: userQuery }] }] };
            if (systemPrompt) payload.systemInstruction = { parts: [{ text: systemPrompt }] };
            if (jsonSchema) {
                payload.generationConfig = {
                    responseMimeType: "application/json",
                    responseSchema: jsonSchema
                };
            }

            let lastError = null;
            for (let i = 0; i < 3; i++) { // Retry up to 3 times
                try {
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (!response.ok) {
                        // For server errors (5xx) or rate limiting (429), we can retry
                        if (response.status === 429 || response.status >= 500) {
                            lastError = new Error(`API failed with status ${response.status}`);
                            // Wait before retrying
                            await new Promise(resolve => setTimeout(resolve, 1000 * Math.pow(2, i)));
                            continue; // Go to next iteration
                        } else {
                            // For other client errors, fail immediately
                            const errorBody = await response.text();
                            console.error("API Error Body:", errorBody);
                            return { success: false, data: null, error: `The AI service returned an error (status: ${response.status}). Please check your settings.` };
                        }
                    }
                   
                    const result = await response.json();
                    const text = result.candidates?.[0]?.content?.parts?.[0]?.text;

                    if (!text) {
                        // This can happen if the safety filters are triggered. Don't retry.
                        console.error("No text in Gemini response:", result);
                        return { success: false, data: null, error: "The AI returned an empty response. Please try rephrasing your request." };
                    }
                    return { success: true, data: text, error: null }; // Success

                } catch (error) {
                    lastError = error; // This will catch 'Failed to fetch'
                    // Wait before retrying
                    await new Promise(resolve => setTimeout(resolve, 1000 * Math.pow(2, i)));
                }
            }

            // If all retries fail
            console.error("Final error after retries in callGemini:", lastError);
            return { success: false, data: null, error: "Could not connect to the AI service. Please check your internet connection and try again." };
        }
       
        async function handleAiAnalysis() {
            const analysisData = gradebookState.students.map(student => {
                const finalGrade = calculateFinalGrade(student.id, gradebookState.categories, gradebookState.assignments, gradebookState.grades);
                return { name: `${student.firstName} ${student.lastName}`, finalGrade: finalGrade.percent };
            });
            const userQuery = `Analyze this gradebook data: ${JSON.stringify(analysisData)}. Provide a brief, 2-3 sentence class summary, identify students who are excelling (over 90%), and students who need support (below 70%).`;
            const systemPrompt = "You are an expert, friendly educational assistant. Provide a concise, helpful, and positive summary. Use Markdown for formatting.";
           
            const result = await callGemini(userQuery, systemPrompt);
            if (result.success) {
                let html = result.data
                    .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                    .replace(/\n\s*[\*-]\s/g, '</li><li>')
                    .replace(/\n/g, '<br>');
                return `<ul><li>${html}</li></ul>`.replace('<ul><li><br>', '<ul>').replace(/<\/li><\/ul>/, '</li></ul>');
            } else {
                return `âŒ ${result.error}`;
            }
        }
       
        async function handleAiPrompt(prompt) {
            aiAssistantModal.style.display = 'flex';
            aiLoader.style.display = 'flex';
            aiResponseContainer.innerHTML = '';
           
            const studentNames = gradebookState.students.map(s => `${s.firstName} ${s.lastName}`).join(', ');
            const categoryNames = gradebookState.categories.map(c => c.name).join(', ');

            const context = `Context:\n- Students: ${studentNames || 'None'}\n- Categories: ${categoryNames || 'None'}`;
            const userQuery = `${context}\n\nTeacher's request: "${prompt}"`;
            const systemPrompt = "You are a gradebook assistant. Understand the teacher's request and respond ONLY with a JSON object matching the schema to perform an action.";
            const jsonSchema = {
                type: "OBJECT",
                properties: {
                    "action": { "type": "STRING", "enum": ["create_assignment", "add_grades", "analyze_grades", "unknown"] },
                    "details": {
                        "type": "OBJECT",
                        "properties": { "name": { "type": "STRING" }, "category": { "type": "STRING" }, "points": { "type": "NUMBER" } }
                    },
                    "grades": {
                        "type": "ARRAY",
                        "items": { "type": "OBJECT", "properties": { "studentName": { "type": "STRING" }, "score": { "type": "NUMBER" } } }
                    }
                }
            };
           
            const result = await callGemini(userQuery, systemPrompt, jsonSchema);
            let confirmationMessage = '';

            if (result.success) {
                 try {
                    const command = JSON.parse(result.data);
                    switch(command.action) {
                        case 'create_assignment':
                            const { name, category, points } = command.details;
                            const cat = gradebookState.categories.find(c => c.name.toLowerCase() === category.toLowerCase());
                            if (name && cat && points) {
                                await addDoc(collection(db, `${publicPath()}/class_materials/${userData.id}/assignments`), { name, categoryId: cat.id, points, dueDate: new Date().toISOString().split('T')[0]});
                                confirmationMessage = `âœ… Assignment "${name}" was successfully created.`;
                            } else {
                                confirmationMessage = `âŒ Could not create assignment. Make sure the category "${category}" exists.`;
                            }
                            break;
                        case 'analyze_grades':
                            confirmationMessage = await handleAiAnalysis();
                            break;
                        default:
                            confirmationMessage = "Sorry, I didn't understand that. You can create assignments or ask for analysis.";
                            break;
                    }
                } catch (e) {
                     confirmationMessage = `âŒ There was an issue processing the AI's response. Please try again.`;
                }
            } else {
                confirmationMessage = `âŒ ${result.error}`;
            }

            aiResponseContainer.innerHTML = confirmationMessage;
            aiLoader.style.display = 'none';
        }

        // --- Student Details Snapshot ---
        async function openStudentDetailsModal(studentId) {
            studentDetailsModal.style.display = 'flex';
            const contentDiv = document.getElementById('student-details-content');
            contentDiv.innerHTML = `<div class="text-center p-8"><svg class="animate-spin h-8 w-8 text-indigo-600 mx-auto" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg><p class="mt-2">Loading student snapshot...</p></div>`;

            const studentDoc = await getDoc(doc(db, `${publicPath()}/all_users`, studentId));
            if (!studentDoc.exists()) {
                contentDiv.innerHTML = `<p class="text-center">Student not found.</p>`;
                return;
            }
            const student = { id: studentDoc.id, ...studentDoc.data() };
            document.getElementById('student-details-title').textContent = `Snapshot for ${student.firstName} ${student.lastName}`;

            // --- Tab HTML and Data Fetching ---
            const summaryHtmlPromise = getSummaryHtml(student);
            const scheduleHtmlPromise = getScheduleHtml(student);
            const attendanceHtmlPromise = getAttendanceHtml(student);
            const missingHtmlPromise = getMissingAssignmentsHtml(student);
            const notesHtmlPromise = getNotesHtml(student);

            const [summaryHtml, scheduleHtml, attendanceHtml, missingHtml, notesHtml] = await Promise.all([summaryHtmlPromise, scheduleHtmlPromise, attendanceHtmlPromise, missingHtmlPromise, notesHtmlPromise]);

            contentDiv.innerHTML = `
                <div class="bg-white p-6 rounded-lg shadow-md mb-6">
                    ${summaryHtml}
                </div>
                <div class="bg-white rounded-lg shadow-md">
                    <div class="border-b border-gray-200">
                        <nav id="student-details-tabs" class="flex -mb-px space-x-6 px-6">
                            <button data-tab="schedule" class="tab-btn whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm active">Schedule</button>
                            <button data-tab="attendance" class="tab-btn whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm">Attendance</button>
                            <button data-tab="missing" class="tab-btn whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm">Missing Assignments</button>
                            <button data-tab="notes" class="tab-btn whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm">Teacher Notes</button>
                        </nav>
                    </div>
                    <div class="p-6">
                        <div id="schedule-tab-content" class="tab-content">${scheduleHtml}</div>
                        <div id="attendance-tab-content" class="tab-content hidden">${attendanceHtml}</div>
                        <div id="missing-tab-content" class="tab-content hidden">${missingHtml}</div>
                        <div id="notes-tab-content" class="tab-content hidden">${notesHtml}</div>
                    </div>
                </div>
            `;
           
            // --- Event Listeners for Tabs and Notes ---
            document.getElementById('student-details-tabs').addEventListener('click', (e) => {
                if (e.target.matches('.tab-btn')) {
                    const tabName = e.target.dataset.tab;
                    document.querySelectorAll('#student-details-tabs .tab-btn').forEach(btn => btn.classList.remove('active'));
                    e.target.classList.add('active');
                    document.querySelectorAll('.tab-content').forEach(content => content.classList.add('hidden'));
                    document.getElementById(`${tabName}-tab-content`).classList.remove('hidden');
                }
            });

            const saveNoteBtn = document.getElementById('save-teacher-note-btn');
            if(saveNoteBtn) {
                saveNoteBtn.addEventListener('click', async () => {
                    const noteText = document.getElementById('teacher-note-textarea').value;
                    const teacherId = userData.id;
                    const noteRef = doc(db, `${publicPath()}/teacher_data/${teacherId}/student_notes`, student.id);
                    await setDoc(noteRef, { note: noteText, updatedAt: serverTimestamp() }, { merge: true });
                    saveNoteBtn.textContent = 'Saved!';
                    setTimeout(() => { saveNoteBtn.textContent = 'Save Note'; }, 2000);
                });
            }
        }

        async function getSummaryHtml(student) {
            const rosterQuery = query(collection(db, `${publicPath()}/roster_entries`), where("studentId", "==", student.id));
            const rosterSnap = await getDocs(rosterQuery);
            let gradeSum = 0;
            let classCount = 0;
           
            for (const rosterDoc of rosterSnap.docs) {
                const teacherId = rosterDoc.data().teacherId;
                const categoriesSnap = await getDocs(collection(db, `${publicPath()}/class_materials/${teacherId}/categories`));
                const assignmentsSnap = await getDocs(collection(db, `${publicPath()}/class_materials/${teacherId}/assignments`));
                const gradesSnap = await getDocs(query(collection(db, `${publicPath()}/grades`), where("studentId", "==", student.id), where("teacherId", "==", teacherId)));

                const categories = categoriesSnap.docs.map(d => ({ id: d.id, ...d.data() }));
                const assignments = assignmentsSnap.docs.map(d => ({ id: d.id, ...d.data() }));
                const grades = {};
                gradesSnap.docs.forEach(d => { grades[`${student.id}_${d.data().assignmentId}`] = d.data(); });

                const finalGrade = calculateFinalGrade(student.id, categories, assignments, grades);
                if (finalGrade.percent !== 'N/A') {
                    gradeSum += parseFloat(finalGrade.percent);
                    classCount++;
                }
            }
           
            const overallAverage = classCount > 0 ? (gradeSum / classCount).toFixed(2) : 'N/A';
            return `
                <div class="flex items-center justify-between">
                     <div>
                        <h3 class="text-xl font-bold">${student.firstName} ${student.lastName}</h3>
                        <p class="text-sm text-gray-500">User Number: ${student.userNumber}</p>
                    </div>
                    <div class="text-center">
                        <p class="text-sm text-gray-500">Overall Average</p>
                        <p class="text-4xl font-bold ${getGradeColor(overallAverage)}">${overallAverage}%</p>
                    </div>
                </div>
            `;
        }
       
        async function getAttendanceHtml(student) {
            const attendanceQuery = query(collection(db, `${publicPath()}/attendance`), where("studentId", "==", student.id), where("teacherId", "==", userData.id));
            const attendanceSnap = await getDocs(attendanceQuery);
            if (attendanceSnap.empty) return `<p class="text-gray-500">No attendance records for this class.</p>`;
           
            const attendanceRecords = attendanceSnap.docs.map(doc => doc.data()).sort((a, b) => new Date(b.date) - new Date(a.date));

            let html = '<ul class="divide-y divide-gray-200">';
            attendanceRecords.forEach(data => {
                const statusMap = { 'P': 'Present', 'A': 'Absent', 'T': 'Tardy' };
                const colorMap = { 'P': 'bg-green-100 text-green-800', 'A': 'bg-red-100 text-red-800', 'T': 'bg-yellow-100 text-yellow-800' };
                html += `<li class="py-3 flex justify-between items-center">
                    <span class="font-medium">${new Date(data.date + 'T00:00:00').toLocaleDateString()}</span>
                    <span class="text-sm font-semibold px-2 py-1 rounded-full ${colorMap[data.status]}">${statusMap[data.status]}</span>
                </li>`;
            });
            html += '</ul>';
            return html;
        }
       
        async function getMissingAssignmentsHtml(student) {
            const missing = gradebookState.assignments.filter(a => {
                const gradeKey = `${student.id}_${a.id}`;
                const gradeData = gradebookState.grades[gradeKey];
                return !gradeData || (gradeData.score == null && gradeData.status !== 'Excused' && gradeData.status !== 'Incomplete');
            });

            if (missing.length === 0) return `<p class="text-gray-500">No missing assignments in this class. Great job!</p>`;

            let html = '<ul class="divide-y divide-gray-200">';
            missing.forEach(a => {
                html += `<li class="py-3">
                    <p class="font-medium">${a.name}</p>
                    <p class="text-sm text-gray-500">Due: ${a.dueDate ? new Date(a.dueDate + 'T00:00:00').toLocaleDateString() : 'N/A'}</p>
                </li>`;
            });
            html += '</ul>';
            return html;
        }

        async function getNotesHtml(student) {
            const teacherId = userData.id;
            const noteRef = doc(db, `${publicPath()}/teacher_data/${teacherId}/student_notes`, student.id);
            const noteSnap = await getDoc(noteRef);
            const existingNote = noteSnap.exists() ? noteSnap.data().note : '';
           
            return `
                <div>
                    <label for="teacher-note-textarea" class="block text-sm font-medium text-gray-700">Private Notes (only visible to you)</label>
                    <textarea id="teacher-note-textarea" rows="8" class="w-full mt-1 p-2 border rounded-md">${existingNote}</textarea>
                    <div class="mt-4 text-right">
                        <button id="save-teacher-note-btn" class="bg-indigo-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-indigo-700 transition">Save Note</button>
                    </div>
                </div>
            `;
        }

        async function getScheduleHtml(student) {
            const scheduleRef = doc(db, `${publicPath()}/schedules`, student.id);
            const scheduleSnap = await getDoc(scheduleRef);

            if (!scheduleSnap.exists() || !scheduleSnap.data().schedule) {
                return `<p class="text-gray-500">No schedule has been set for this student.</p>`;
            }

            const scheduleData = scheduleSnap.data().schedule;
            // Fetch all teacher names at once for efficiency
            const teacherIds = [...new Set(scheduleData.map(item => item.teacherId).filter(Boolean))];
            const teacherDocs = await Promise.all(teacherIds.map(id => getDoc(doc(db, `${publicPath()}/all_users`, id))));
            const teacherNames = teacherDocs.reduce((acc, doc) => {
                if(doc.exists()) acc[doc.id] = `${doc.data().firstName} ${doc.data().lastName}`;
                return acc;
            }, {});

            let html = `
                <table class="min-w-full bg-white border">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-4 py-2 text-left font-semibold">Period</th>
                            <th class="px-4 py-2 text-left font-semibold">Class Name</th>
                            <th class="px-4 py-2 text-left font-semibold">Teacher</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            scheduleData.forEach(item => {
                html += `
                    <tr class="border-b">
                        <td class="px-4 py-2">${item.period}</td>
                        <td class="px-4 py-2">${item.className || ''}</td>
                        <td class="px-4 py-2">${teacherNames[item.teacherId] || 'N/A'}</td>
                    </tr>
                `;
            });
            html += `</tbody></table>`;
            return html;
        }

        // --- Firestore Listeners ---
        function setupTeacherListeners() {
            const teacherId = userData.id;
            const publicMaterialsRef = `${publicPath()}/class_materials/${teacherId}`;
           
            unsubscribers.push(
                onSnapshot(query(collection(db, `${publicPath()}/roster_entries`), where("teacherId", "==", teacherId)), snap => {
                    gradebookState.students = snap.docs.map(d => ({ id: d.data().studentId, ...d.data() }));
                    if (gradebookModal.style.display === 'flex') {
                        renderGradebookBody();
                        calculateAndDisplayAverages();
                    }
                    if (attendanceModal.style.display === 'flex') {
                        renderAttendance();
                    }
                }),
                onSnapshot(collection(db, `${publicMaterialsRef}/categories`), snap => {
                    gradebookState.categories = snap.docs.map(d => ({ id: d.id, ...d.data() })).sort((a,b) => a.name.localeCompare(b.name));
                    if(gradebookModal.style.display === 'flex') renderTeacherGradebook();
                }),
                onSnapshot(collection(db, `${publicMaterialsRef}/assignments`), snap => {
                    gradebookState.assignments = snap.docs.map(d => ({ id: d.id, ...d.data() })).sort((a,b) => new Date(a.dueDate) - new Date(b.dueDate));
                    if(gradebookModal.style.display === 'flex') renderTeacherGradebook();
                }),
                onSnapshot(query(collection(db, `${publicPath()}/grades`), where("teacherId", "==", teacherId)), snap => {
                    gradebookState.grades = {};
                    snap.docs.forEach(d => { gradebookState.grades[`${d.data().studentId}_${d.data().assignmentId}`] = d.data(); });
                    if(gradebookModal.style.display === 'flex') renderTeacherGradebook();
                }),
                 onSnapshot(query(collection(db, `${publicPath()}/attendance`), where("teacherId", "==", teacherId)), snap => {
                    gradebookState.attendance = {};
                    snap.docs.forEach(d => {
                        const data = d.data();
                        if(!gradebookState.attendance[data.date]) gradebookState.attendance[data.date] = {};
                        gradebookState.attendance[data.date][data.studentId] = data.status;
                    });
                     if (attendanceModal.style.display === 'flex') renderAttendance();
                }),
                onSnapshot(collection(db, `${publicPath()}/teacher_data/${teacherId}/personal_resources`), snap => {
                    const resourceList = snap.docs.map(d => ({id: d.id, ...d.data()}));
                    const container = document.getElementById('personal-resource-list');
                    const emptyState = document.getElementById('empty-state');
                    container.innerHTML = '';
                    if (resourceList.length === 0) {
                        emptyState.style.display = 'block'; return;
                    }
                    emptyState.style.display = 'none';
                    resourceList.forEach(res => {
                        container.innerHTML += `<div class="new-item bg-gray-50 p-3 rounded-lg flex justify-between items-center border"><a href="${res.url}" target="_blank" class="font-semibold text-indigo-600 hover:underline">${res.title}</a><button data-id="${res.id}" class="delete-resource-btn bg-red-100 text-red-700 text-xs font-bold py-1 px-2 rounded-full hover:bg-red-200">Delete</button></div>`;
                    });
                }),
                onSnapshot(query(collection(db, assessmentPath()), where("teacherId", "==", userData.id)), snap => {
                    const assessments = snap.docs.map(d => ({id: d.id, ...d.data()}));
                    renderTeacherAssessmentList(assessments);
                }),
                onSnapshot(query(collection(db, `${publicMaterialsRef}/announcements`), orderBy("createdAt", "desc")), snap => {
                    const announcements = snap.docs.map(d => ({ id: d.id, ...d.data() }));
                    renderTeacherAnnouncements(announcements);
                })
            );
        }
       
        async function setupStudentListeners() {
            studentDashboard.innerHTML = `
                <div class="max-w-4xl mx-auto grid grid-cols-1 md:grid-cols-2 gap-8">
                     <div class="bg-white p-6 rounded-xl shadow-md">
                        <h2 class="text-xl font-bold mb-4 text-gray-800">ðŸ“¢ Class Announcements</h2>
                        <div id="student-announcement-list" class="space-y-3 max-h-[60vh] overflow-y-auto">
                            <p class="text-gray-500">Loading announcements...</p>
                        </div>
                     </div>
                     <div class="space-y-8">
                         <div class="bg-white p-6 rounded-xl shadow-md">
                             <h2 class="text-xl font-bold mb-4 text-gray-800">Applications</h2>
                             <div class="grid grid-cols-1 gap-4">
                                  <a href="#" id="open-studentvue-btn" class="flex items-center p-4 bg-gray-50 hover:bg-gray-100 rounded-lg transition border">
                                     <svg class="w-8 h-8 text-purple-600 mr-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7v8a2 2 0 002 2h4M8 7a2 2 0 012-2h4a2 2 0 012 2v8a2 2 0 01-2 2h-4a2 2 0 01-2-2l-4-4z"></path></svg>
                                     <span class="font-semibold text-gray-700">StudentVUE</span>
                                  </a>
                                  <a href="#" id="open-student-attendance-btn" class="flex items-center p-4 bg-gray-50 hover:bg-gray-100 rounded-lg transition border">
                                     <svg class="w-8 h-8 text-cyan-600 mr-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg>
                                     <span class="font-semibold text-gray-700">Attendance</span>
                                  </a>
                                  <a href="#" id="open-student-assessment-btn" class="flex items-center p-4 bg-gray-50 hover:bg-gray-100 rounded-lg transition border">
                                     <svg class="w-8 h-8 text-indigo-600 mr-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01"></path></svg>
                                     <span class="font-semibold text-gray-700">Securely Assignments</span>
                                  </a>
                             </div>
                         </div>
                         <div class="bg-white p-6 rounded-xl shadow-md">
                            <h2 class="text-xl font-bold mb-4 text-gray-800">ðŸ“š Shared Resources</h2>
                            <div id="student-shared-resources-list" class="space-y-3 max-h-[40vh] overflow-y-auto">
                                <p class="text-gray-500">Loading resources...</p>
                            </div>
                         </div>
                     </div>
                </div>
            `;
           
            document.getElementById('open-studentvue-btn').addEventListener('click', (e) => {
                e.preventDefault();
                openGradebook('student_list');
            });
             document.getElementById('open-student-attendance-btn').addEventListener('click', (e) => {
                e.preventDefault();
                openAttendanceModal();
            });

            document.getElementById('open-student-assessment-btn').addEventListener('click', (e) => {
                e.preventDefault();
                assessmentModal.style.display = 'flex';
                showAssessmentDashboard();
            });

            const rosterQuery = query(collection(db, `${publicPath()}/roster_entries`), where("studentId", "==", userData.id));
            unsubscribers.push(onSnapshot(rosterQuery, async (rosterSnap) => {
                if (rosterSnap.empty) {
                    document.getElementById('student-announcement-list').innerHTML = `<p>You are not enrolled in any classes.</p>`;
                    document.getElementById('student-shared-resources-list').innerHTML = `<p class="text-center text-gray-500">No resources to show.</p>`;
                    renderStudentAssessmentList([], []);
                    return;
                }
               
                const teacherIds = rosterSnap.docs.map(doc => doc.data().teacherId);

                // Fetch announcements from all teachers
                const announcementsPromises = teacherIds.map(async (teacherId) => {
                    const teacherSnap = await getDoc(doc(db, `${publicPath()}/all_users`, teacherId));
                    const teacherName = teacherSnap.exists() ? `${teacherSnap.data().firstName} ${teacherSnap.data().lastName}` : 'A teacher';
                    const announcementsQuery = query(collection(db, `${publicPath()}/class_materials/${teacherId}/announcements`), orderBy("createdAt", "desc"));
                    const announcementsSnap = await getDocs(announcementsQuery);
                    return announcementsSnap.docs.map(doc => ({ id: doc.id, teacherName, ...doc.data() }));
                });

                const announcementsByTeacher = await Promise.all(announcementsPromises);
                let allAnnouncements = announcementsByTeacher.flat();
                allAnnouncements.sort((a, b) => b.createdAt.seconds - a.createdAt.seconds);
                renderStudentAnnouncements(allAnnouncements);

                // Fetch and render shared resources
                const resourcesPromises = teacherIds.map(async (teacherId) => {
                    const teacherSnap = await getDoc(doc(db, `${publicPath()}/all_users`, teacherId));
                    const teacherName = teacherSnap.exists() ? `${teacherSnap.data().firstName} ${teacherSnap.data().lastName}` : 'A teacher';
                    const resourcesQuery = query(collection(db, `${publicPath()}/shared_resources/${teacherId}/items`), orderBy("createdAt", "desc"));
                    const resourcesSnap = await getDocs(resourcesQuery);
                    return resourcesSnap.docs.map(doc => ({ id: doc.id, teacherName, ...doc.data() }));
                });
                const resourcesByTeacher = await Promise.all(resourcesPromises);
                let allSharedResources = resourcesByTeacher.flat();
                allSharedResources.sort((a, b) => b.createdAt.seconds - a.createdAt.seconds);
                renderStudentSharedResources(allSharedResources);


                // Fetch assessments from all teachers
                const submissionsQuery = query(collection(db, `${publicPath()}/assessment_submissions`), where("studentId", "==", userData.id));
                const unsubSubmissions = onSnapshot(submissionsQuery, (submissionsSnap) => {
                    const submissions = submissionsSnap.docs.map(doc => ({ id: doc.id, ...doc.data()}));
                    if (teacherIds.length > 0) {
                        const assessmentsQuery = query(collection(db, assessmentPath()), where("teacherId", "in", teacherIds));
                        const unsubAssessments = onSnapshot(assessmentsQuery, (snapshot) => {
                            const assessments = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                            renderStudentAssessmentList(assessments, submissions);
                        });
                        unsubscribers.push(unsubAssessments);
                    } else {
                        renderStudentAssessmentList([], []);
                    }
                });
                unsubscribers.push(unsubSubmissions);
            }));
        }
       
        async function setupAdminListeners() {
            unsubscribers.push(onSnapshot(collection(db, `${publicPath()}/all_users`), (snapshot) => {
                const users = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                const teachers = users.filter(u => u.role === 'teacher');
                adminState.teachers = teachers;
                const students = users.filter(u => u.role === 'student');
                adminState.students = students;
               
                const assignTeacherList = document.getElementById('assign-teacher-list');
                if(assignTeacherList) {
                    assignTeacherList.innerHTML = teachers.map(t => `
                        <div class="flex items-center gap-2">
                            <input type="checkbox" name="assign-teacher" value="${t.id}" id="teacher-check-${t.id}" class="h-4 w-4 text-indigo-600 focus:ring-indigo-500 border-gray-300 rounded">
                            <label for="teacher-check-${t.id}" class="flex-grow text-sm text-gray-600">${t.firstName} ${t.lastName}</label>
                            <input type="text" name="class-name-for-${t.id}" class="w-1/2 p-1 border rounded-md text-sm" placeholder="Class Name (e.g., Math)">
                        </div>
                    `).join('') || '<p class="text-sm text-gray-500">No teachers available to assign.</p>';
                }

                const renderUserList = (userList, elementId, isStudentList = false) => {
                    const container = document.getElementById(elementId);
                    container.innerHTML = '';
                    if (userList.length === 0) {
                        container.innerHTML = '<p class="text-gray-500">No users found.</p>';
                        return;
                    }
                    userList.forEach(user => {
                        container.innerHTML += `
                            <div class="flex justify-between items-center p-2 bg-gray-50 rounded">
                                <div>
                                    <p class="font-semibold">${user.firstName} ${user.lastName}</p>
                                    <p class="text-sm text-gray-500">User Number: ${user.userNumber}</p>
                                </div>
                                <div>
                                    ${isStudentList ? `<button data-id="${user.id}" class="edit-student-btn bg-blue-500 text-white px-2 py-1 text-xs rounded-md hover:bg-blue-600">Edit</button>` : ''}
                                    <button data-id="${user.id}" class="delete-user-btn bg-red-500 text-white px-2 py-1 text-xs rounded-md hover:bg-red-600 ml-2">Delete</button>
                                </div>
                            </div>
                        `;
                    });
                };
                renderUserList(teachers, 'admin-teacher-list', false);
                renderUserList(students, 'admin-student-list', true);
            }));
        }
       
        async function saveGrade(studentId, assignmentId, gradeData) {
            const teacherId = userData.id;
            const gradeRef = doc(db, `${publicPath()}/grades`, `${studentId}_${assignmentId}`);
           
            const dataToSave = {
                studentId,
                assignmentId,
                teacherId,
                score: gradeData.score || null,
                status: gradeData.status || null,
                comment: gradeData.comment || null,
            };

            // Don't save if all fields are null/empty
            if (dataToSave.score === null && dataToSave.status === null && dataToSave.comment === null) {
                 await deleteDoc(gradeRef).catch(e => console.error("Error deleting grade:", e));
            } else {
                 await setDoc(gradeRef, dataToSave, { merge: true }).catch(e => console.error("Error saving grade:", e));
            }
        }
       
        // --- Teacher Attendance ---
        function renderAttendance() {
            const date = document.getElementById('attendance-date').value || new Date().toISOString().split('T')[0];
            const attendanceForDate = gradebookState.attendance[date] || {};
            const body = document.getElementById('attendance-body');
            body.innerHTML = '';
            gradebookState.students.forEach(student => {
                const status = attendanceForDate[student.id] || 'P';
                body.innerHTML += `<tr>
                    <td class="px-4 py-2">${student.firstName} ${student.lastName}</td>
                    <td class="px-4 py-2 text-center space-x-2">
                        <button data-student-id="${student.id}" data-status="P" class="attendance-btn ${status === 'P' ? 'active attendance-p' : 'bg-gray-200'}">P</button>
                        <button data-student-id="${student.id}" data-status="A" class="attendance-btn ${status === 'A' ? 'active attendance-a' : 'bg-gray-200'}">A</button>
                        <button data-student-id="${student.id}" data-status="T" class="attendance-btn ${status === 'T' ? 'active attendance-t' : 'bg-gray-200'}">T</button>
                    </td>
                </tr>`;
            });
        }
       
        async function saveAttendance(studentId, date, status) {
            const teacherId = userData.id;
            const attendanceId = `${date}_${studentId}`;
            await setDoc(doc(db, `${publicPath()}/attendance`, attendanceId), {
                studentId,
                date,
                status,
                teacherId
            });
        }

        // --- Assessment Logic ---
        function showAssessmentDashboard() {
            // Correctly show/hide dashboards based on user role
            if (userRole === 'teacher') {
                teacherAssessmentDashboard.classList.remove('hidden');
                studentAssessmentDashboard.classList.add('hidden');
            } else if (userRole === 'student') {
                teacherAssessmentDashboard.classList.add('hidden');
                studentAssessmentDashboard.classList.remove('hidden');
            }
           
            aiAssessmentCreator.classList.add('hidden');
            manualAssessmentCreator.classList.add('hidden');
            document.getElementById('test-taking-view').classList.add('hidden');
            document.getElementById('test-results-view').classList.add('hidden');
            document.getElementById('student-review-view').classList.add('hidden');
            document.getElementById('test-results-dashboard-view').classList.add('hidden');
        }

        function renderTeacherAssessmentList(assessments) {
            const container = document.getElementById('assessment-list-container');
            if (assessments.length === 0) {
                container.innerHTML = `<div class="text-center py-10 text-gray-500">No assignments created yet. Use one of the creation tools to get started!</div>`;
                return;
            }
            container.innerHTML = assessments.map(ass => `
                <div class="bg-white p-4 rounded-lg shadow-sm border flex justify-between items-center mb-4">
                    <div>
                        <h4 class="font-bold text-lg">${ass.title}</h4>
                        <p class="text-sm text-gray-500">
                            ${ass.questions.length} questions | ${ass.attemptsAllowed === 1 ? '1 Attempt' : 'Unlimited Attempts'} ${ass.timeLimit > 0 ? `| ${ass.timeLimit} min timer` : ''}
                            ${ass.isProctored ? '<span class="ml-2 px-2 py-1 text-xs font-semibold text-indigo-800 bg-indigo-100 rounded-full">Monitored</span>' : ''}
                        </p>
                         <p class="text-xs text-gray-400 mt-1">Scores released: ${ass.scoresReleased ? 'Yes' : 'No'}</p>
                    </div>
                    <div>
                        <button data-id="${ass.id}" class="view-results-btn bg-blue-100 text-blue-800 px-3 py-1 rounded-md ml-2 text-sm font-semibold">View Results</button>
                        <button data-id="${ass.id}" class="delete-assessment-btn bg-red-100 text-red-800 px-3 py-1 rounded-md ml-2 text-sm font-semibold">Delete</button>
                    </div>
                </div>
            `).join('');
        }
       
        function renderStudentAssessmentList(assessments, submissions) {
            const container = document.getElementById('student-assessment-list-container');
             if (assessments.length === 0) {
                container.innerHTML = `<div class="text-center py-10 text-gray-500">No assignments from your teacher yet.</div>`;
                return;
            }
            container.innerHTML = assessments.map(ass => {
                const submission = submissions.find(s => s.assessmentId === ass.id);
                let buttonHtml = '';

                if (submission) {
                    if (ass.scoresReleased) {
                        buttonHtml = `<button data-assessment-id="${ass.id}" data-submission-id="${submission.id}" class="review-assessment-btn bg-green-100 text-green-800 font-semibold px-4 py-2 rounded-md hover:bg-green-200">Review</button>`;
                    } else if (ass.attemptsAllowed === 1) {
                        buttonHtml = `<span class="text-gray-600 font-semibold py-2 px-4">Submitted - Awaiting Scores</span>`;
                    } else {
                        buttonHtml = `<button data-id="${ass.id}" class="start-assessment-btn bg-blue-600 text-white font-semibold px-4 py-2 rounded-md hover:bg-blue-700">Start Again</button>`;
                    }
                } else {
                     buttonHtml = `<button data-id="${ass.id}" class="start-assessment-btn bg-blue-600 text-white font-semibold px-4 py-2 rounded-md hover:bg-blue-700">Start Assignment</button>`;
                }
               
                return `
                <div class="bg-white p-4 rounded-lg shadow-sm border flex justify-between items-center mb-4">
                    <div>
                        <h4 class="font-bold text-lg">${ass.title}</h4>
                        <p class="text-sm text-gray-500">
                           ${ass.questions.length} questions | ${ass.attemptsAllowed === 1 ? '1 Attempt' : 'Unlimited Attempts'} ${ass.timeLimit > 0 ? `| ${ass.timeLimit} min` : ''}
                           ${ass.isProctored ? '<span class="ml-2 px-2 py-1 text-xs font-semibold text-indigo-800 bg-indigo-100 rounded-full">Monitored</span>' : ''}
                        </p>
                    </div>
                    <div>
                        ${buttonHtml}
                    </div>
                </div>
            `}).join('');
        }
       
        async function handleGenerateTest(e) {
            e.preventDefault();
            const btn = document.getElementById('generate-test-btn');
            const errorMessageDiv = document.getElementById('ai-error-message');
            errorMessageDiv.textContent = '';
            btn.disabled = true;
            btn.innerHTML = `<svg class="animate-spin h-5 w-5 mx-auto text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg> Generating...`;
           
            const title = document.getElementById('ai-test-name').value;
            const topic = document.getElementById('ai-topic').value;
            const gradeLevel = document.getElementById('ai-grade-level').value;
            const numQuestions = document.getElementById('ai-num-questions').value;
            const timeLimit = parseInt(document.getElementById('ai-test-timer').value) || 0;
            const attemptsAllowed = document.getElementById('ai-attempts').value === '1' ? 1 : 'unlimited';
            const releaseMethod = document.getElementById('ai-release-scores').value;
            const isProctored = document.getElementById('ai-enable-proctoring').checked;
            const questionTypes = Array.from(document.querySelectorAll('#ai-question-types input:checked')).map(cb => cb.value);

            const userQuery = `Create a test with exactly ${numQuestions} questions for a ${gradeLevel} class on the topic of "${topic}". The test should contain a mix of these question types: ${questionTypes.join(', ')}.`;
            const systemPrompt = "You are an AI that creates educational assessments. Respond with ONLY a valid JSON object based on the user's request. The JSON should match the provided schema. Do not include any text before or after the JSON object.";
            const jsonSchema = {
                type: "OBJECT",
                properties: {
                    questions: {
                        type: "ARRAY",
                        items: {
                            type: "OBJECT",
                            properties: {
                                questionType: { "type": "STRING", "enum": ["multiple-choice", "true-false", "fill-in-the-blank"] },
                                questionText: { type: "STRING" },
                                options: { type: "ARRAY", items: { type: "STRING" } },
                                correctAnswerIndex: { type: "NUMBER" },
                                correctAnswer: { "type": "STRING" }
                            },
                            required: ["questionType", "questionText"]
                        }
                    }
                }
            };

            const result = await callGemini(userQuery, systemPrompt, jsonSchema);

            if (result.success) {
                try {
                    const assessmentData = JSON.parse(result.data);
                    if (assessmentData.questions && assessmentData.questions.length > 0) {
                        const questionsWithPoints = assessmentData.questions.map(q => ({...q, points: 1}));
                        await addDoc(collection(db, assessmentPath()), {
                            title,
                            teacherId: userData.id,
                            questions: questionsWithPoints,
                            timeLimit,
                            attemptsAllowed,
                            releaseMethod,
                            isProctored,
                            scoresReleased: releaseMethod === 'immediate',
                            createdAt: serverTimestamp()
                        });
                        document.getElementById('ai-assessment-form').reset();
                        showAssessmentDashboard();
                    } else {
                        throw new Error("AI did not generate questions.");
                    }
                } catch(e) {
                     errorMessageDiv.textContent = "The AI returned a response in an unexpected format. Please try again.";
                }
            } else {
                errorMessageDiv.textContent = result.error;
            }

            btn.disabled = false;
            btn.textContent = 'Generate Assignment';
        }

        async function startTest(assessmentId) {
            const docRef = doc(db, assessmentPath(), assessmentId);
            const docSnap = await getDoc(docRef);

            if (docSnap.exists()) {
                assessmentState = { // Reset state for new test
                    currentTest: { id: docSnap.id, ...docSnap.data() },
                    currentQuestionIndex: 0,
                    userAnswers: {},
                    timerInterval: null,
                    proctoringFlags: [],
                    testSubmitted: false
                };

                if (assessmentState.currentTest.isProctored) {
                    showConfirmationModal(
                        'Full-Screen Monitoring Enabled',
                        "This is a monitored assignment and must be completed in full-screen mode. Leaving full-screen will be recorded and sent to your teacher. Click 'OK' to begin.",
                        enterFullscreenAndStart
                    );
                } else {
                    beginTest();
                }
            } else {
                console.error("No such assessment!");
            }
        }
        
        function enterFullscreenAndStart() {
            document.documentElement.requestFullscreen().then(() => {
                beginTest();
            }).catch(err => {
                // Silently fail if fullscreen is not allowed, but still start the test.
                // The error is expected in environments like sandboxed iframes.
                beginTest(); 
            });
        }
        
        async function beginTest() {
            studentAssessmentDashboard.classList.add('hidden');
            document.getElementById('test-taking-view').classList.remove('hidden');

            if (assessmentState.currentTest.isProctored) {
                 await setDoc(doc(db, `${publicPath()}/user_activity`, userData.id), {
                    status: 'working',
                    assignmentTitle: assessmentState.currentTest.title,
                    studentName: `${userData.firstName} ${userData.lastName}`,
                    teacherId: assessmentState.currentTest.teacherId,
                    since: serverTimestamp()
                });
                document.addEventListener('fullscreenchange', handleFullscreenChange);
            }

            if (assessmentState.currentTest.timeLimit > 0) {
                startTestTimer(assessmentState.currentTest.timeLimit);
            }
            renderCurrentQuestion();
        }

        function handleFullscreenChange() {
            if (!document.fullscreenElement && assessmentState.currentTest && !assessmentState.testSubmitted) {
                assessmentState.proctoringFlags.push({
                    timestamp: new Date().toISOString(),
                    questionIndex: assessmentState.currentQuestionIndex
                });
            }
        }
       
        function startTestTimer(minutes) {
            let seconds = minutes * 60;
            const timerDisplay = document.getElementById('test-timer-display');

            assessmentState.timerInterval = setInterval(() => {
                const min = Math.floor(seconds / 60);
                const sec = seconds % 60;
                timerDisplay.textContent = `Time Left: ${min}:${sec < 10 ? '0' : ''}${sec}`;
                seconds--;
                if (seconds < 0) {
                    clearInterval(assessmentState.timerInterval);
                    timerDisplay.textContent = "Time's up!";
                    submitTest();
                }
            }, 1000);
        }

        function renderCurrentQuestion() {
            const questionContainer = document.getElementById('question-container');
            const testNav = document.getElementById('test-navigation');
            const question = assessmentState.currentTest.questions[assessmentState.currentQuestionIndex];

            let optionsHtml = '';
            switch(question.questionType) {
                case 'true-false':
                    optionsHtml = `
                        <div class="space-y-3">
                            <label class="block p-4 border rounded-lg cursor-pointer hover:bg-gray-50 assessment-option">
                                <input type="radio" name="answer" value="true" class="mr-3"> True
                            </label>
                            <label class="block p-4 border rounded-lg cursor-pointer hover:bg-gray-50 assessment-option">
                                <input type="radio" name="answer" value="false" class="mr-3"> False
                            </label>
                        </div>
                    `;
                    break;
                case 'fill-in-the-blank':
                    optionsHtml = `
                        <div>
                            <input type="text" name="answer" class="w-full p-2 border rounded-md" placeholder="Type your answer...">
                        </div>
                    `;
                    break;
                case 'multiple-choice':
                default:
                     optionsHtml = `<div class="space-y-3">
                        ${question.options.map((option, index) => `
                            <label class="block p-4 border rounded-lg cursor-pointer hover:bg-gray-50 assessment-option">
                                <input type="radio" name="answer" value="${index}" class="mr-3">
                                ${option}
                            </label>
                        `).join('')}
                    </div>`;
                    break;
            }

            questionContainer.innerHTML = `
                <p class="text-sm text-gray-500 mb-2">Question ${assessmentState.currentQuestionIndex + 1} of ${assessmentState.currentTest.questions.length}</p>
                <h3 class="text-2xl font-bold mb-6">${question.questionText.replace(/___/g, '<span class="font-mono text-gray-400">[blank]</span>')}</h3>
                ${optionsHtml}
            `;
           
            const isLastQuestion = assessmentState.currentQuestionIndex === assessmentState.currentTest.questions.length - 1;
            testNav.innerHTML = `
                <p>${assessmentState.currentTest.title}</p>
                <button id="next-question-btn" class="bg-indigo-600 text-white font-semibold py-2 px-6 rounded-lg hover:bg-indigo-700">
                    ${isLastQuestion ? 'Submit' : 'Next'}
                </button>
            `;
        }

        function handleNextQuestion() {
            const question = assessmentState.currentTest.questions[assessmentState.currentQuestionIndex];
            let answerValue;

            if (question.questionType === 'fill-in-the-blank') {
                answerValue = document.querySelector('input[name="answer"]').value;
                 if (!answerValue.trim()) { alert("Please enter an answer."); return; }
            } else {
                const selectedRadio = document.querySelector('input[name="answer"]:checked');
                if (!selectedRadio) { alert("Please select an answer."); return; }
                answerValue = selectedRadio.value;
            }
           
            assessmentState.userAnswers[assessmentState.currentQuestionIndex] = answerValue;

            const isLastQuestion = assessmentState.currentQuestionIndex === assessmentState.currentTest.questions.length - 1;
            if (isLastQuestion) {
                submitTest();
            } else {
                assessmentState.currentQuestionIndex++;
                renderCurrentQuestion();
            }
        }

        async function submitTest() {
            if (assessmentState.testSubmitted) return; // Prevent double submission
            assessmentState.testSubmitted = true;

            if (assessmentState.timerInterval) clearInterval(assessmentState.timerInterval);
            document.removeEventListener('fullscreenchange', handleFullscreenChange);

            if (assessmentState.currentTest.isProctored) {
                if (document.fullscreenElement) {
                    document.exitFullscreen();
                }
                await setDoc(doc(db, `${publicPath()}/user_activity`, userData.id), {
                    status: 'idle',
                    studentName: `${userData.firstName} ${userData.lastName}`,
                    teacherId: assessmentState.currentTest.teacherId,
                });
            }
           
            let totalScore = 0;
            let totalPossiblePoints = 0;
            const questions = assessmentState.currentTest.questions;

            for (let i = 0; i < questions.length; i++) {
                 const question = questions[i];
                 const userAnswer = assessmentState.userAnswers[i];
                 const points = question.points || 1;
                 totalPossiblePoints += points;
                 
                 if (userAnswer === undefined) continue;

                 let isCorrect = false;
                 switch (question.questionType) {
                    case 'true-false':
                        isCorrect = userAnswer.toString().toLowerCase() === question.correctAnswer.toString().toLowerCase();
                        break;
                    case 'fill-in-the-blank':
                        isCorrect = userAnswer.trim().toLowerCase() === question.correctAnswer.trim().toLowerCase();
                        break;
                    case 'multiple-choice':
                    default:
                        isCorrect = parseInt(userAnswer) === question.correctAnswerIndex;
                        break;
                 }
                 if(isCorrect) totalScore += points;
            }

            await addDoc(collection(db, `${publicPath()}/assessment_submissions`), {
                studentId: userData.id,
                teacherId: assessmentState.currentTest.teacherId,
                assessmentId: assessmentState.currentTest.id,
                answers: assessmentState.userAnswers,
                score: totalScore,
                totalPossiblePoints: totalPossiblePoints,
                proctoringFlags: assessmentState.proctoringFlags,
                submittedAt: serverTimestamp()
            });

            document.getElementById('test-taking-view').classList.add('hidden');
            const resultsView = document.getElementById('test-results-view');
            const resultsContent = document.getElementById('test-result-content');
            resultsView.classList.remove('hidden');

            if (assessmentState.currentTest.releaseMethod === 'immediate') {
                resultsContent.innerHTML = `<p class="text-5xl font-bold text-green-600 mb-6">${totalScore} / ${totalPossiblePoints} Points</p>`;
            } else {
                resultsContent.innerHTML = `<p class="text-lg text-gray-700">Your responses have been submitted. Your teacher will release your score after they have reviewed it.</p>`;
            }
        }

        async function viewTestResults(assessmentId) {
            teacherAssessmentDashboard.classList.add('hidden');
            const resultsView = document.getElementById('test-results-dashboard-view');
            resultsView.classList.remove('hidden');
            resultsView.innerHTML = `<div class="text-center py-10">Loading results...</div>`;

            const assessmentDoc = await getDoc(doc(db, assessmentPath(), assessmentId));
            if (!assessmentDoc.exists()) {
                resultsView.innerHTML = `<p>Error: Assessment not found.</p>`;
                return;
            }
            const assessment = {id: assessmentDoc.id, ...assessmentDoc.data()};

            const submissionsQuery = query(collection(db, `${publicPath()}/assessment_submissions`), where("assessmentId", "==", assessmentId));
            const submissionsSnap = await getDocs(submissionsQuery);
           
            const results = [];
            for (const subDoc of submissionsSnap.docs) {
                const submission = subDoc.data();
                const studentDoc = await getDoc(doc(db, `${publicPath()}/all_users`, submission.studentId));
                if(studentDoc.exists()) {
                    const student = studentDoc.data();
                    results.push({
                        submissionId: subDoc.id,
                        studentName: `${student.firstName} ${student.lastName}`,
                        score: submission.score,
                        totalPossiblePoints: submission.totalPossiblePoints,
                        proctoringFlags: submission.proctoringFlags || [],
                        submittedAt: submission.submittedAt.toDate().toLocaleString()
                    });
                }
            }

            let totalScoreSum = 0;
            let totalPossiblePointsSum = 0;
            results.forEach(r => {
                totalScoreSum += r.score;
                totalPossiblePointsSum += r.totalPossiblePoints;
            });
            const averagePercent = totalPossiblePointsSum > 0 ? ((totalScoreSum / totalPossiblePointsSum) * 100).toFixed(1) : 'N/A';
           
            let releaseScoresButton = '';
            if (assessment.releaseMethod === 'manual' && !assessment.scoresReleased) {
                releaseScoresButton = `<button data-id="${assessment.id}" class="release-scores-btn bg-purple-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-purple-700 transition shadow-sm">Release Scores</button>`;
            } else if (assessment.scoresReleased) {
                releaseScoresButton = `<span class="text-sm font-semibold text-green-600">Scores Released</span>`;
            }

            resultsView.innerHTML = `
                <div class="flex justify-between items-center mb-6">
                    <div>
                        <button id="back-to-teacher-assessment-dashboard-btn" class="text-sm text-blue-600 hover:underline">&larr; Back to Dashboard</button>
                        <h3 class="text-3xl font-bold">${assessment.title} - Results</h3>
                    </div>
                    <div class="flex items-center gap-4">
                        ${releaseScoresButton}
                         <button data-id="${assessmentId}" class="export-grades-btn bg-green-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-green-700 transition shadow-sm">
                            <i class="fas fa-file-export mr-2"></i> Export to Gradebook
                        </button>
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6 text-center">
                    <div class="bg-gray-50 p-4 rounded-lg"><p class="text-sm text-gray-500">Submissions</p><p class="text-2xl font-bold">${results.length}</p></div>
                    <div class="bg-gray-50 p-4 rounded-lg"><p class="text-sm text-gray-500">Class Average</p><p class="text-2xl font-bold">${averagePercent}%</p></div>
                </div>

                <table class="min-w-full bg-white">
                    <thead class="bg-gray-100">
                        <tr>
                            <th class="px-4 py-2 text-left">Student Name</th>
                            <th class="px-4 py-2 text-left">Score</th>
                            ${assessment.isProctored ? '<th class="px-4 py-2 text-left">Proctoring Status</th>' : ''}
                            <th class="px-4 py-2 text-left">Submitted At</th>
                             ${assessment.attemptsAllowed === 1 ? '<th class="px-4 py-2 text-left">Actions</th>' : ''}
                        </tr>
                    </thead>
                    <tbody>
                        ${results.map(r => {
                             let proctoringStatusHtml = '';
                             if (assessment.isProctored) {
                                 if (r.proctoringFlags.length > 0) {
                                     const flagTimes = r.proctoringFlags.map(f => new Date(f.timestamp).toLocaleTimeString()).join(', ');
                                     proctoringStatusHtml = `<td class="px-4 py-2"><span class="text-red-600 font-bold" title="Exited at: ${flagTimes}"><i class="fas fa-flag mr-1"></i> ${r.proctoringFlags.length} Flag(s)</span></td>`;
                                 } else {
                                     proctoringStatusHtml = `<td class="px-4 py-2"><span class="text-green-600 font-bold"><i class="fas fa-check-circle mr-1"></i> Secure</span></td>`;
                                 }
                             }
                            return `
                                <tr class="border-b">
                                    <td class="px-4 py-2">${r.studentName}</td>
                                    <td class="px-4 py-2 font-semibold">${r.score} / ${r.totalPossiblePoints}</td>
                                    ${proctoringStatusHtml}
                                    <td class="px-4 py-2">${r.submittedAt}</td>
                                    ${assessment.attemptsAllowed === 1 ? `<td class="px-4 py-2"><button data-id="${r.submissionId}" class="reset-attempt-btn text-xs bg-yellow-100 text-yellow-800 font-semibold py-1 px-2 rounded-full hover:bg-yellow-200">Reset Attempt</button></td>` : ''}
                                </tr>
                            `;
                        }).join('')}
                         ${results.length === 0 ? `<tr><td colspan="5" class="text-center py-4 text-gray-500">No students have taken this assignment yet.</td></tr>` : ''}
                    </tbody>
                </table>
            `;
        }
       
        // --- Event Handlers ---
        async function handleChatbotSubmit(e) {
            e.preventDefault();
            const originalInput = chatbotInput.value;
            const input = originalInput.trim();
            if (!input) return;

            addUserMessage(originalInput);
            chatbotInput.value = '';
            chatbotInput.disabled = true;

            if (conversationState === 0) { // Ask new or returning
                if (input.toLowerCase().includes('new')) {
                    conversationState = 1; askQuestion();
                } else if (input.toLowerCase().includes('return')) {
                    conversationState = 10; askQuestion();
                } else { addBotMessage("I didn't understand. Please say 'new' or 'returning'."); }
            }
            else if (conversationState === 1) { // Ask for code
                const correctCode = userRole === 'admin' ? ADMIN_CODE : (userRole === 'teacher' ? TEACHER_CODE : STUDENT_CODE);
                if (input.toUpperCase() === correctCode) {
                    conversationState = 2; askQuestion();
                } else { addBotMessage(`That's not the correct registration code for a ${userRole}. Please try again.`); }
            }
            else if (conversationState === 2) { // Ask for first name
                 userData.firstName = toTitleCase(originalInput.trim());
                 conversationState = 3; askQuestion();
            }
            else if (conversationState === 3) { // Ask for last name
                userData.lastName = toTitleCase(originalInput.trim());
                await generateCredentials();
            }
            else if (conversationState === 10) { // Handle login
                await loginUser(input, userRole);
            }

            chatbotInput.disabled = false;
            chatbotInput.focus();
        }

        function handleLogout() {
            cleanupListeners();
            localStorage.removeItem('learningSpaceUser');
            signOut(auth).catch((error) => {
                console.error("Logout failed:", error);
            }).finally(() => {
                window.location.reload();
            });
        }
       
        async function handleAddResource(e) {
            e.preventDefault();
            const title = document.getElementById('resource-title').value.trim();
            const url = document.getElementById('resource-url').value.trim();
            const isShared = document.getElementById('share-with-students-checkbox').checked;

            if (title && url && userData.id) {
                const teacherId = userData.id;
                if (isShared) {
                    await addDoc(collection(db, `${publicPath()}/shared_resources/${teacherId}/items`), { title, url, createdAt: serverTimestamp() });
                } else {
                    await addDoc(collection(db, `${publicPath()}/teacher_data/${teacherId}/personal_resources`), { title, url, createdAt: serverTimestamp() });
                }
                e.target.reset();
            }
        }

        async function handleAddAnnouncement() {
            const textInput = document.getElementById('announcement-text');
            const text = textInput.value.trim();
            if (text && userData.id) {
                await addDoc(collection(db, `${publicPath()}/class_materials/${userData.id}/announcements`), {
                    text,
                    teacherId: userData.id,
                    createdAt: serverTimestamp()
                });
                textInput.value = '';
            }
        }
       
        async function handleAddUser(e) {
            e.preventDefault();
            const errorDiv = document.getElementById('add-user-error');
            errorDiv.classList.add('hidden');
            errorDiv.textContent = '';

            // --- 1. Get all form data ---
            const userNumberInput = document.getElementById('add-user-number');
            const userNumber = parseInt(userNumberInput.value);
            const role = document.getElementById('add-user-role').value;
            const firstName = toTitleCase(document.getElementById('add-user-firstName').value.trim());
            const lastName = toTitleCase(document.getElementById('add-user-lastName').value.trim());

            // --- 2. Perform all validations ---
            // Basic validation
            if (!firstName || !lastName || !userNumber || !role) {
                errorDiv.textContent = "Please fill out all required fields.";
                errorDiv.classList.remove('hidden');
                return;
            }

            // a. Check for duplicate user number
            const q = query(collection(db, `${publicPath()}/all_users`), where("userNumber", "==", userNumber));
            const existingUserSnap = await getDocs(q);
            if (!existingUserSnap.empty) {
                errorDiv.textContent = `User Number ${userNumber} is already taken.`;
                errorDiv.classList.remove('hidden');
                return;
            }

            // b/c. Student-specific validations
            let enrollments = [];
            if (role === 'student') {
                const selectedTeachersCheckboxes = Array.from(document.querySelectorAll('input[name="assign-teacher"]:checked'));
                if (selectedTeachersCheckboxes.length === 0) {
                    errorDiv.textContent = "Please assign the student to at least one teacher.";
                    errorDiv.classList.remove('hidden');
                    return;
                }

                for (const checkbox of selectedTeachersCheckboxes) {
                    const teacherId = checkbox.value;
                    const classNameInput = document.querySelector(`input[name="class-name-for-${teacherId}"]`);
                    const className = classNameInput ? classNameInput.value.trim() : '';

                    if (!className) {
                        errorDiv.textContent = `Please provide a class name for teacher: ${checkbox.nextElementSibling.textContent.trim()}.`;
                        errorDiv.classList.remove('hidden');
                        return; // Stop on first error
                    }
                    enrollments.push({ teacherId, className });
                }
            }
           
            // --- 3. If all validations pass, write to DB ---
            try {
                let userSpecificData = {};
                if (role === 'teacher') {
                    userSpecificData = { subjects: document.getElementById('add-user-subjects').value.split(',').map(s => s.trim()) };
                }
               
                const userToSave = { firstName, lastName, role, userNumber, ...userSpecificData, createdAt: serverTimestamp() };
                const newUserRef = await addDoc(collection(db, `${publicPath()}/all_users`), userToSave);

                if (role === 'student') {
                    for (const enrollment of enrollments) {
                        await addDoc(collection(db, `${publicPath()}/roster_entries`), {
                            studentId: newUserRef.id,
                            teacherId: enrollment.teacherId,
                            firstName,
                            lastName,
                            userNumber,
                            className: enrollment.className,
                            createdAt: serverTimestamp()
                        });
                    }
                }

                addUserForm.reset();
                addUserModal.style.display = 'none';

            } catch (error) {
                console.error("Error creating user:", error);
                errorDiv.textContent = "An unexpected error occurred. Please try again.";
                errorDiv.classList.remove('hidden');
            }
        }

        function openGradeDetailsModal(studentId, assignmentId) {
            const student = gradebookState.students.find(s => s.id === studentId);
            const assignment = gradebookState.assignments.find(a => a.id === assignmentId);
            const gradeData = gradebookState.grades[`${studentId}_${assignmentId}`] || {};

            if (!student || !assignment) return;

            document.getElementById('grade-details-title').textContent = `Grade for ${student.firstName} on ${assignment.name}`;
            document.getElementById('grade-details-student-id').value = studentId;
            document.getElementById('grade-details-assignment-id').value = assignmentId;
            document.getElementById('grade-details-score').value = gradeData.score ?? '';
            document.getElementById('grade-details-status').value = gradeData.status ?? '';
            document.getElementById('grade-details-comment').value = gradeData.comment ?? '';

            gradeDetailsModal.style.display = 'flex';
        }

        async function handleGradeDetailsSave(e) {
            e.preventDefault();
            const studentId = document.getElementById('grade-details-student-id').value;
            const assignmentId = document.getElementById('grade-details-assignment-id').value;
            const gradeData = {
                score: document.getElementById('grade-details-score').value,
                status: document.getElementById('grade-details-status').value,
                comment: document.getElementById('grade-details-comment').value,
            };
            await saveGrade(studentId, assignmentId, gradeData);
            gradeDetailsModal.style.display = 'none';
        }

        async function handleGradeDelete() {
            const studentId = document.getElementById('grade-details-student-id').value;
            const assignmentId = document.getElementById('grade-details-assignment-id').value;
            await saveGrade(studentId, assignmentId, {}); // Saving an empty object will trigger deletion
            gradeDetailsModal.style.display = 'none';
        }

        function openAssignmentDetailsModal(assignmentId) {
            const assignment = gradebookState.assignments.find(a => a.id === assignmentId);
            if (!assignment) return;

            document.getElementById('assignment-details-title').textContent = `Details for: ${assignment.name}`;

            const gradesForAssignment = gradebookState.students.map(student => {
                return {
                    student,
                    grade: gradebookState.grades[`${student.id}_${assignmentId}`]
                };
            }).filter(item => item.grade && item.grade.score !== null && item.grade.score !== '' && item.grade.status !== 'Excused');
           
            let classAverage = 0, highest = -1, lowest = Infinity, count = 0;
            gradesForAssignment.forEach(item => {
                const score = parseFloat(item.grade.score);
                if (!isNaN(score)) {
                    classAverage += score;
                    if (score > highest) highest = score;
                    if (score < lowest) lowest = score;
                    count++;
                }
            });
        }

        // --- Manual Assessment ---
        function addManualQuestion() {
            const container = document.getElementById('manual-questions-container');
            const questionIndex = container.children.length;
            const questionDiv = document.createElement('div');
            questionDiv.className = 'question-editor bg-gray-50 p-4 rounded-lg border';
            questionDiv.dataset.index = questionIndex;

            questionDiv.innerHTML = `
                <div class="flex justify-between items-center mb-2">
                    <h4 class="font-semibold">Question ${questionIndex + 1}</h4>
                    <button type="button" class="remove-question-btn text-red-500 hover:text-red-700">Remove</button>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <textarea class="question-text w-full p-2 border rounded-md" placeholder="Enter question text..." rows="4"></textarea>
                    <div>
                        <div class="flex items-center gap-4">
                            <div class="flex-grow">
                                <label class="block text-sm font-medium text-gray-700">Question Type</label>
                                <select class="question-type-select w-full p-2 border rounded-md mt-1">
                                    <option value="multiple-choice">Multiple Choice</option>
                                    <option value="true-false">True/False</option>
                                    <option value="fill-in-the-blank">Fill-in-the-Blank</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700">Points</label>
                                <input type="number" class="question-points w-20 p-2 border rounded-md mt-1" value="1" min="1">
                            </div>
                        </div>
                    </div>
                </div>
                <div class="question-options-container mt-4"></div>
            `;
            container.appendChild(questionDiv);
            renderManualQuestionOptions(questionDiv, 'multiple-choice');
        }

        function renderManualQuestionOptions(questionDiv, type) {
            const container = questionDiv.querySelector('.question-options-container');
            const questionIndex = questionDiv.dataset.index;
            container.innerHTML = '';
            switch(type) {
                case 'multiple-choice':
                    container.innerHTML = `
                        <label class="font-semibold">Options</label>
                        <p class="text-sm text-gray-500">Select the correct answer using the radio button.</p>
                        <div class="mc-options-list space-y-2 mt-2" data-q-index="${questionIndex}">
                             <div class="flex items-center">
                                <input type="radio" name="correct-answer-${questionIndex}" class="mr-2" checked>
                                <input type="text" class="w-full p-1 border rounded-md mc-option-text" placeholder="Option 1">
                                <button type="button" class="remove-mc-option-btn text-red-500 ml-2 font-bold">x</button>
                            </div>
                             <div class="flex items-center">
                                <input type="radio" name="correct-answer-${questionIndex}" class="mr-2">
                                <input type="text" class="w-full p-1 border rounded-md mc-option-text" placeholder="Option 2">
                                <button type="button" class="remove-mc-option-btn text-red-500 ml-2 font-bold">x</button>
                            </div>
                        </div>
                        <button type="button" class="add-mc-option-btn text-sm text-blue-600 hover:underline mt-2">+ Add Option</button>
                    `;
                    break;
                case 'true-false':
                    container.innerHTML = `
                        <label class="font-semibold">Correct Answer</label>
                        <div class="flex space-x-4 mt-2">
                            <label><input type="radio" name="correct-answer-${questionIndex}" value="true" class="mr-1" checked> True</label>
                            <label><input type="radio" name="correct-answer-${questionIndex}" value="false" class="mr-1"> False</label>
                        </div>
                    `;
                    break;
                case 'fill-in-the-blank':
                    container.innerHTML = `
                        <label class="font-semibold">Correct Answer</label>
                         <p class="text-sm text-gray-500">Use '___' in the question text for the blank.</p>
                        <input type="text" class="correct-answer-text w-full p-2 border rounded-md mt-1" placeholder="Enter the exact answer...">
                    `;
                    break;
            }
        }
       
        async function saveManualTest() {
            const errorDiv = document.getElementById('manual-test-error');
            errorDiv.classList.add('hidden');
            errorDiv.textContent = '';

            const title = document.getElementById('manual-test-title').value.trim();
            const timeLimit = parseInt(document.getElementById('manual-test-timer').value) || 0;
            const attemptsAllowed = document.getElementById('manual-attempts').value === '1' ? 1 : 'unlimited';
            const releaseMethod = document.getElementById('manual-release-scores').value;
            const isProctored = document.getElementById('manual-enable-proctoring').checked;

            if (!title) {
                errorDiv.textContent = "Please enter a title for the assignment.";
                errorDiv.classList.remove('hidden');
                return;
            }
           
            const questions = [];
            const questionEditors = document.querySelectorAll('.question-editor');
           
            if (questionEditors.length === 0) {
                errorDiv.textContent = "Please add at least one question.";
                errorDiv.classList.remove('hidden');
                return;
            }

            for(const [index, editor] of Array.from(questionEditors).entries()) {
                const questionText = editor.querySelector('.question-text').value.trim();
                const questionType = editor.querySelector('.question-type-select').value;
                const points = parseInt(editor.querySelector('.question-points').value);

                if (!questionText) {
                    errorDiv.textContent = `Please make sure Question ${index + 1} has text.`;
                    errorDiv.classList.remove('hidden');
                    return;
                }
                 if (isNaN(points) || points < 1) {
                    errorDiv.textContent = `Please enter a valid point value for Question ${index + 1}.`;
                    errorDiv.classList.remove('hidden');
                    return;
                }


                let questionData = { questionText, questionType, points };
               
                if (questionType === 'multiple-choice') {
                    const options = Array.from(editor.querySelectorAll('.mc-option-text')).map(input => input.value.trim());
                    const correctIndex = Array.from(editor.querySelectorAll(`input[name="correct-answer-${editor.dataset.index}"]`)).findIndex(radio => radio.checked);
                    if (options.some(opt => !opt) || correctIndex === -1) {
                        errorDiv.textContent = `Please fill out all options for Question ${index + 1} and select a correct answer.`;
                        errorDiv.classList.remove('hidden');
                        return;
                    }
                    questionData.options = options;
                    questionData.correctAnswerIndex = correctIndex;
                } else if (questionType === 'true-false') {
                    const correctAnswer = editor.querySelector(`input[name="correct-answer-${editor.dataset.index}"]:checked`).value;
                    questionData.correctAnswer = correctAnswer;
                } else if (questionType === 'fill-in-the-blank') {
                    const correctAnswer = editor.querySelector('.correct-answer-text').value.trim();
                    if (!correctAnswer) {
                        errorDiv.textContent = `Please provide an answer for the fill-in-the-blank Question ${index + 1}.`;
                        errorDiv.classList.remove('hidden');
                        return;
                    }
                    questionData.correctAnswer = correctAnswer;
                }
                questions.push(questionData);
            }
           
            try {
                await addDoc(collection(db, assessmentPath()), {
                    title,
                    teacherId: userData.id,
                    questions,
                    timeLimit,
                    attemptsAllowed,
                    releaseMethod,
                    isProctored,
                    scoresReleased: releaseMethod === 'immediate',
                    createdAt: serverTimestamp()
                });
               
                document.getElementById('manual-test-title').value = '';
                document.getElementById('manual-test-timer').value = '0';
                document.getElementById('manual-questions-container').innerHTML = '';
                showAssessmentDashboard();
            } catch (error) {
                console.error("Error saving manual test:", error);
                errorDiv.textContent = "An error occurred while saving the assignment. Please try again.";
                errorDiv.classList.remove('hidden');
            }
        }

        // --- New Attendance Modal ---
        function openAttendanceModal() {
            attendanceModal.style.display = 'flex';
            document.getElementById('teacher-attendance-content').classList.add('hidden');
            document.getElementById('student-attendance-content').classList.add('hidden');

            if (userRole === 'teacher') {
                document.getElementById('teacher-attendance-content').classList.remove('hidden');
                document.getElementById('attendance-date').value = new Date().toISOString().split('T')[0];
                renderAttendance();
            } else if (userRole === 'student') {
                document.getElementById('student-attendance-content').classList.remove('hidden');
                renderStudentAttendanceView();
            }
        }

        async function renderStudentAttendanceView() {
            const container = document.getElementById('student-attendance-content');
            container.innerHTML = `<div class="text-center p-8">Loading your attendance...</div>`;

            const rosterQuery = query(collection(db, `${publicPath()}/roster_entries`), where("studentId", "==", userData.id));
            const rosterSnap = await getDocs(rosterQuery);
            if (rosterSnap.empty) {
                container.innerHTML = `<p class="p-8 text-center">Not enrolled in any classes.</p>`;
                return;
            }

            let html = '';
            for (const rosterDoc of rosterSnap.docs) {
                const rosterData = rosterDoc.data();
                const teacherSnap = await getDoc(doc(db, `${publicPath()}/all_users`, rosterData.teacherId));
                const teacherName = teacherSnap.exists() ? `${teacherSnap.data().firstName} ${teacherSnap.data().lastName}` : 'N/A';
               
                html += `<div class="mb-6"><h3 class="text-xl font-bold mb-2">${rosterData.className} (${teacherName})</h3>`;

                const attendanceQuery = query(collection(db, `${publicPath()}/attendance`), where("studentId", "==", userData.id), where("teacherId", "==", rosterData.teacherId));
                const attendanceSnap = await getDocs(attendanceQuery);
               
                if (attendanceSnap.empty) {
                    html += `<p class="text-gray-500">No attendance records for this class.</p></div>`;
                    continue;
                }
                const records = attendanceSnap.docs.map(d => d.data()).sort((a,b) => new Date(b.date) - new Date(a.date));

                html += '<ul class="divide-y divide-gray-200 border rounded-md">';
                records.forEach(data => {
                    const statusMap = { 'P': 'Present', 'A': 'Absent', 'T': 'Tardy' };
                    const colorMap = { 'P': 'bg-green-100 text-green-800', 'A': 'bg-red-100 text-red-800', 'T': 'bg-yellow-100 text-yellow-800' };
                    html += `<li class="py-3 px-4 flex justify-between items-center">
                        <span class="font-medium">${new Date(data.date + 'T00:00:00').toLocaleDateString()}</span>
                        <span class="text-sm font-semibold px-2 py-1 rounded-full ${colorMap[data.status]}">${statusMap[data.status]}</span>
                    </li>`;
                });
                html += '</ul></div>';
            }
            container.innerHTML = html;
        }

        // --- New Schedule Manager Functions (Admin) ---
        function openScheduleManager() {
            scheduleManagerModal.style.display = 'flex';
            document.getElementById('schedule-editor').classList.add('hidden');
            const studentSelect = document.getElementById('schedule-student-select');
           
            studentSelect.innerHTML = '<option value="">-- Select a Student --</option>' +
                adminState.students
                .sort((a,b) => a.lastName.localeCompare(b.lastName))
                .map(s => `<option value="${s.id}">${s.lastName}, ${s.firstName}</option>`).join('');
        }

        async function renderScheduleEditor(studentId) {
            const editor = document.getElementById('schedule-editor');
            if (!studentId) {
                editor.classList.add('hidden');
                return;
            }
           
            const scheduleRef = doc(db, `${publicPath()}/schedules`, studentId);
            const scheduleSnap = await getDoc(scheduleRef);
            const scheduleData = scheduleSnap.exists() ? scheduleSnap.data().schedule : [];

            const teacherOptions = adminState.teachers.map(t => `<option value="${t.id}">${t.lastName}, ${t.firstName}</option>`).join('');

            const editorBody = document.getElementById('schedule-editor-body');
            let bodyHtml = '';
            for (let i = 1; i <= 8; i++) {
                const entry = scheduleData.find(item => item.period === i) || {};
                bodyHtml += `
                    <tr class="border-b">
                        <td class="px-4 py-2 font-bold">${i}</td>
                        <td class="px-4 py-2">
                            <input type="text" data-period="${i}" class="schedule-class-name w-full p-1 border rounded" value="${entry.className || ''}" placeholder="Class Name">
                        </td>
                        <td class="px-4 py-2">
                            <select data-period="${i}" class="schedule-teacher-select w-full p-1 border rounded">
                                <option value="">-- Select Teacher --</option>
                                ${teacherOptions}
                            </select>
                        </td>
                    </tr>
                `;
            }
            editorBody.innerHTML = bodyHtml;

            // Now set the selected teacher for each period
            for (let i = 1; i <= 8; i++) {
                const entry = scheduleData.find(item => item.period === i) || {};
                if(entry.teacherId) {
                    editorBody.querySelector(`select[data-period="${i}"]`).value = entry.teacherId;
                }
            }
           
            editor.classList.remove('hidden');
        }

        async function saveSchedule() {
            const studentId = document.getElementById('schedule-student-select').value;
            if (!studentId) return;

            const scheduleData = [];
            for (let i = 1; i <= 8; i++) {
                const className = document.querySelector(`.schedule-class-name[data-period="${i}"]`).value.trim();
                const teacherId = document.querySelector(`.schedule-teacher-select[data-period="${i}"]`).value;
                if(className || teacherId) { // Only save rows that have some data
                    scheduleData.push({
                        period: i,
                        className: className || null,
                        teacherId: teacherId || null
                    });
                }
            }

            const scheduleRef = doc(db, `${publicPath()}/schedules`, studentId);
            await setDoc(scheduleRef, { schedule: scheduleData, updatedAt: serverTimestamp() });

            const saveBtn = document.getElementById('save-schedule-btn');
            saveBtn.textContent = 'Saved!';
            setTimeout(() => { saveBtn.textContent = 'Save Schedule'; }, 2000);
        }

        // --- Event Listeners Setup ---
        function setupGlobalListeners() {
            // Static elements that are always present
            document.getElementById('teacher-btn').addEventListener('click', () => startChatbot('teacher'));
            document.getElementById('student-btn').addEventListener('click', () => startChatbot('student'));
            document.getElementById('admin-btn').addEventListener('click', () => startChatbot('admin'));
            chatbotForm.addEventListener('submit', handleChatbotSubmit);
            logoutBtn.addEventListener('click', handleLogout);

            // Modals
            openTeacherVueBtn.addEventListener('click', (e) => { e.preventDefault(); openGradebook('teacher'); });
            closeGradebookBtn.addEventListener('click', closeGradebook);
            openAssessmentBtn.addEventListener('click', (e) => { e.preventDefault(); assessmentModal.style.display = 'flex'; showAssessmentDashboard(); });
            closeAssessmentBtn.addEventListener('click', () => {
                assessmentModal.style.display = 'none';
                if (assessmentState.timerInterval) clearInterval(assessmentState.timerInterval);
            });
            aiPromptForm.addEventListener('submit', (e) => { e.preventDefault(); handleAiPrompt(document.getElementById('ai-prompt-input').value); });
            closeAiModalBtn.addEventListener('click', () => { aiAssistantModal.style.display = 'none'; });
            closeStudentDetailsBtn.addEventListener('click', () => studentDetailsModal.style.display = 'none');
            closeGradeDetailsBtn.addEventListener('click', () => gradeDetailsModal.style.display = 'none');
            gradeDetailsForm.addEventListener('submit', handleGradeDetailsSave);
            document.getElementById('delete-grade-btn').addEventListener('click', handleGradeDelete);
            closeAssignmentDetailsBtn.addEventListener('click', () => assignmentDetailsModal.style.display = 'none');
            document.getElementById('live-activity-btn').addEventListener('click', openLiveActivityModal);
            document.getElementById('close-live-activity-btn').addEventListener('click', () => {
                liveActivityModal.style.display = 'none';
                // Listener is cleaned up in cleanupListeners() which is called when the modal is closed via this button
                if (unsubscribers['liveActivity']) {
                    unsubscribers['liveActivity']();
                    delete unsubscribers['liveActivity'];
                }
            });


            // New Attendance Modal
            document.getElementById('open-teacher-attendance-btn').addEventListener('click', (e) => { e.preventDefault(); openAttendanceModal(); });
            document.getElementById('close-attendance-modal-btn').addEventListener('click', () => attendanceModal.style.display = 'none');
            document.getElementById('attendance-date').addEventListener('input', renderAttendance);

            // Resource Form
            document.getElementById('add-resource-form').addEventListener('submit', handleAddResource);
           
            // Admin Modals
            addUserBtn.addEventListener('click', () => { addUserModal.style.display = 'flex'; });
            closeAddUserModalBtn.addEventListener('click', () => { addUserModal.style.display = 'none'; });
            addUserRole.addEventListener('change', () => {
                const role = addUserRole.value;
                teacherFields.classList.toggle('hidden', role !== 'teacher');
                studentFields.classList.toggle('hidden', role !== 'student');
            });
            addUserForm.addEventListener('submit', handleAddUser);
            document.getElementById('open-schedule-manager-btn').addEventListener('click', openScheduleManager);
            document.getElementById('close-schedule-manager-btn').addEventListener('click', () => scheduleManagerModal.style.display = 'none');
            document.getElementById('schedule-student-select').addEventListener('change', (e) => renderScheduleEditor(e.target.value));
            document.getElementById('save-schedule-btn').addEventListener('click', saveSchedule);


            // Edit User Modal
            closeEditUserModalBtn.addEventListener('click', () => { editUserModal.style.display = 'none'; });
            editUserForm.addEventListener('submit', handleUpdateUser);

            // Assessment Creation
            document.getElementById('ai-create-test-btn').addEventListener('click', () => {
                teacherAssessmentDashboard.classList.add('hidden');
                aiAssessmentCreator.classList.remove('hidden');
            });
             document.getElementById('cancel-ai-assessment-creation').addEventListener('click', () => {
                showAssessmentDashboard();
            });
            document.getElementById('ai-assessment-form').addEventListener('submit', handleGenerateTest);

             document.getElementById('manual-create-test-btn').addEventListener('click', () => {
                teacherAssessmentDashboard.classList.add('hidden');
                manualAssessmentCreator.classList.remove('hidden');
                document.getElementById('manual-questions-container').innerHTML = ''; // Clear previous
                addManualQuestion(); // Add the first question
            });
            document.getElementById('cancel-manual-assessment-creation').addEventListener('click', showAssessmentDashboard);
            document.getElementById('add-question-btn').addEventListener('click', addManualQuestion);
            document.getElementById('save-manual-test-btn').addEventListener('click', saveManualTest);

            document.getElementById('back-to-student-assessment-dashboard-btn').addEventListener('click', showAssessmentDashboard);
        }

        function setupDelegatedListeners() {
             teacherGradebookView.addEventListener('click', async (e) => {
                if (e.target.matches('.delete-category-btn')) {
                    const categoryId = e.target.dataset.id;
                    await deleteDoc(doc(db, `${publicPath()}/class_materials/${userData.id}/categories`, categoryId));
                }
                 if (e.target.matches('.delete-assignment-btn')) {
                    const assignmentId = e.target.dataset.id;
                    await deleteDoc(doc(db, `${publicPath()}/class_materials/${userData.id}/assignments`, assignmentId));
                }
                const gradeCell = e.target.closest('.grade-cell');
                if (gradeCell) {
                    const studentId = gradeCell.dataset.studentId;
                    const assignmentId = gradeCell.dataset.assignmentId;
                    openGradeDetailsModal(studentId, assignmentId);
                }
                const studentCell = e.target.closest('.student-name-cell');
                if (studentCell) {
                    const studentId = studentCell.dataset.studentId;
                    openStudentDetailsModal(studentId);
                }
                const assignmentLink = e.target.closest('.assignment-details-link');
                if (assignmentLink) {
                    e.preventDefault();
                    const assignmentId = assignmentLink.dataset.assignmentId;
                    openAssignmentDetailsModal(assignmentId);
                }
            });

            teacherGradebookView.addEventListener('submit', async (e) => {
                e.preventDefault();
                if (e.target.id === 'category-form') {
                    const nameInput = document.getElementById('category-name');
                    const weightInput = document.getElementById('category-weight');
                    const name = nameInput.value.trim();
                    const weight = parseInt(weightInput.value);
                    if (name && weight > 0 && weight <= 100) {
                        const currentTotalWeight = gradebookState.categories.reduce((sum, cat) => sum + parseInt(cat.weight || 0), 0);
                        if (currentTotalWeight + weight > 100) {
                            console.error('Total weight cannot exceed 100%.');
                            return;
                        }
                        await addDoc(collection(db, `${publicPath()}/class_materials/${userData.id}/categories`), { name, weight });
                        e.target.reset();
                    }
                } else if (e.target.id === 'assignment-form') {
                    const name = document.getElementById('assignment-name').value.trim();
                    const categoryId = document.getElementById('assignment-category').value;
                    const points = parseInt(document.getElementById('assignment-points').value);
                    const dueDate = document.getElementById('assignment-due-date').value;
                    if (name && categoryId && points >= 0) {
                        await addDoc(collection(db, `${publicPath()}/class_materials/${userData.id}/assignments`), { name, categoryId, points, dueDate: dueDate || new Date().toISOString().split('T')[0] });
                        e.target.reset();
                    }
                }
            });
           
            teacherDashboard.addEventListener('submit', async (e) => {
                if(e.target.id === 'add-announcement-form') {
                    e.preventDefault();
                    handleAddAnnouncement();
                }
            });
           
            teacherDashboard.addEventListener('click', async (e) => {
                 if (e.target.matches('.delete-resource-btn')) {
                     const resourceId = e.target.dataset.id;
                     await deleteDoc(doc(db, `${publicPath()}/teacher_data/${userData.id}/personal_resources`, resourceId));
                 }
                 if (e.target.matches('.delete-announcement-btn')) {
                     const annId = e.target.dataset.id;
                     await deleteDoc(doc(db, `${publicPath()}/class_materials/${userData.id}/announcements`, annId));
                 }
            });
           
             assessmentModal.addEventListener('click', async (e) => {
                 if (e.target.matches('.delete-assessment-btn')) {
                     const assessmentId = e.target.dataset.id;
                     await deleteDoc(doc(db, assessmentPath(), assessmentId));
                 }
                 if (e.target.matches('.view-results-btn')) {
                     const assessmentId = e.target.dataset.id;
                     viewTestResults(assessmentId);
                 }
                 if (e.target.matches('.reset-attempt-btn')) {
                     const submissionId = e.target.dataset.id;
                     await deleteDoc(doc(db, `${publicPath()}/assessment_submissions`, submissionId));
                 }
                  if (e.target.matches('.release-scores-btn')) {
                    const assessmentId = e.target.dataset.id;
                    await updateDoc(doc(db, assessmentPath(), assessmentId), { scoresReleased: true });
                    e.target.textContent = 'Scores Released';
                    e.target.disabled = true;
                    e.target.classList.remove('bg-purple-600', 'hover:bg-purple-700');
                    e.target.classList.add('bg-gray-400');
                 }
                 if (e.target.matches('.export-grades-btn')) {
                    const assessmentId = e.target.dataset.id;
                    openExportGradesModal(assessmentId);
                 }
                 if (e.target.id === 'next-question-btn') {
                    handleNextQuestion();
                 }
                 if (e.target.id === 'back-to-teacher-assessment-dashboard-btn' || e.target.id === 'back-to-review-dashboard-btn') {
                    showAssessmentDashboard();
                 }

                // Student buttons inside assessment modal
                const startBtn = e.target.closest('.start-assessment-btn');
                if(startBtn) {
                    const assessmentId = startBtn.dataset.id;
                    startTest(assessmentId);
                }

                const reviewBtn = e.target.closest('.review-assessment-btn');
                if (reviewBtn) {
                    const { assessmentId, submissionId } = reviewBtn.dataset;
                    reviewStudentSubmission(assessmentId, submissionId);
                }
            });

            studentGradebookListView.addEventListener('click', e => {
                const classCard = e.target.closest('.class-card');
                if (classCard) {
                    const { teacherId, className } = classCard.dataset;
                    openGradebook('student_detail', teacherId, className);
                }
            });

            manualAssessmentCreator.addEventListener('click', e => {
                if (e.target.classList.contains('remove-question-btn')) {
                    e.target.closest('.question-editor').remove();
                }
                if (e.target.classList.contains('add-mc-option-btn')) {
                    const optionsContainer = e.target.previousElementSibling;
                    const newOption = document.createElement('div');
                    newOption.className = 'flex items-center mt-2';
                    newOption.innerHTML = `
                        <input type="radio" name="correct-answer-${optionsContainer.dataset.qIndex}" class="mr-2">
                        <input type="text" class="w-full p-1 border rounded-md mc-option-text" placeholder="Option text...">
                        <button type="button" class="remove-mc-option-btn text-red-500 ml-2 font-bold">x</button>
                    `;
                    optionsContainer.appendChild(newOption);
                }
                if (e.target.classList.contains('remove-mc-option-btn')) {
                    e.target.parentElement.remove();
                }
            });
             manualAssessmentCreator.addEventListener('change', e => {
                if (e.target.classList.contains('question-type-select')) {
                    const questionEditorDiv = e.target.closest('.question-editor');
                    if(questionEditorDiv) {
                        renderManualQuestionOptions(questionEditorDiv, e.target.value);
                    }
                }
            });

            attendanceModal.addEventListener('click', e => {
                if (e.target.matches('.attendance-btn')) {
                    const button = e.target;
                    const studentId = button.dataset.studentId;
                    const status = button.dataset.status;
                    const date = document.getElementById('attendance-date').value || new Date().toISOString().split('T')[0];
                    saveAttendance(studentId, date, status);
                }
            });

            adminDashboard.addEventListener('click', async (e) => {
                if (e.target.matches('.delete-user-btn')) {
                    const userId = e.target.dataset.id;
                     await deleteDoc(doc(db, `${publicPath()}/all_users`, userId));
                }
                if (e.target.matches('.edit-student-btn')) {
                    const studentId = e.target.dataset.id;
                    openEditStudentModal(studentId);
                }
            });
           
             studentGradebookDetailView.addEventListener('input', (e) => {
                 if (e.target.matches('.what-if-slider')) {
                    const assignId = e.target.dataset.assignmentId;
                    const newScore = e.target.value;
                    document.getElementById(`what-if-score-${assignId}`).textContent = newScore;
                   
                    const { studentId, categories, assignments, grades } = JSON.parse(studentGradebookDetailView.dataset.gradeData);
                   
                    const tempGrades = JSON.parse(JSON.stringify(grades));
                    const gradeKey = `${studentId}_${assignId}`;
                    if (!tempGrades[gradeKey]) tempGrades[gradeKey] = {};
                    tempGrades[gradeKey].score = newScore;
                    const whatIfGrade = calculateFinalGrade(studentId, categories, assignments, tempGrades);
                   
                    const gradeDisplay = document.getElementById(`what-if-grade-${assignId}`);
                    const percentDisplay = document.getElementById(`what-if-percent-${assignId}`);
                   
                    gradeDisplay.textContent = whatIfGrade.letter || '--';
                    percentDisplay.textContent = whatIfGrade.percent === 'N/A' ? '--' : `${whatIfGrade.percent}%`;
                   
                    // Update the main grade display at the top
                    const mainGradeDisplay = document.getElementById('student-main-grade-detail');
                    mainGradeDisplay.textContent = whatIfGrade.percent === 'N/A' ? '--' : Math.round(whatIfGrade.percent);
                    mainGradeDisplay.className = `text-5xl font-bold ${getGradeColor(whatIfGrade.percent)}`;
                 }
             });
        }

        // --- New Export to Gradebook Functions ---
        function openExportGradesModal(assessmentId) {
            const modal = document.getElementById('export-grades-modal');
            const select = document.getElementById('export-category-select');
            const errorMsg = document.getElementById('export-category-error');
           
            document.getElementById('export-assessment-id').value = assessmentId;
            document.getElementById('export-status-message').textContent = '';
            document.getElementById('sync-to-gradebook-btn').disabled = false;

            if (gradebookState.categories.length > 0) {
                select.innerHTML = gradebookState.categories.map(c => `<option value="${c.id}">${c.name}</option>`).join('');
                select.classList.remove('hidden');
                errorMsg.classList.add('hidden');
            } else {
                select.innerHTML = '';
                select.classList.add('hidden');
                errorMsg.classList.remove('hidden');
                document.getElementById('sync-to-gradebook-btn').disabled = true;
            }
           
            modal.classList.remove('hidden');
            modal.style.display = 'flex';

            document.getElementById('close-export-grades-btn').onclick = () => modal.style.display = 'none';
            document.getElementById('export-grades-form').onsubmit = (e) => handleSyncToGradebook(e);
        }

        async function handleSyncToGradebook(e) {
            e.preventDefault();
            const btn = document.getElementById('sync-to-gradebook-btn');
            const statusMsg = document.getElementById('export-status-message');
            btn.disabled = true;
            statusMsg.textContent = 'Syncing...';

            const assessmentId = document.getElementById('export-assessment-id').value;
            const categoryId = document.getElementById('export-category-select').value;
           
            // 1. Get Assessment and Submission Data
            const assessmentDoc = await getDoc(doc(db, assessmentPath(), assessmentId));
            if (!assessmentDoc.exists()) {
                statusMsg.textContent = 'Error: Could not find assessment.';
                return;
            }
            const assessment = assessmentDoc.data();
            const totalPoints = assessment.questions.reduce((sum, q) => sum + (q.points || 1), 0);

            const submissionsQuery = query(collection(db, `${publicPath()}/assessment_submissions`), where("assessmentId", "==", assessmentId));
            const submissionsSnap = await getDocs(submissionsQuery);
            const submissions = submissionsSnap.docs.map(d => d.data());

            try {
                // 2. Create New Assignment in Gradebook
                const newAssignmentRef = await addDoc(collection(db, `${publicPath()}/class_materials/${userData.id}/assignments`), {
                    name: `(Test) ${assessment.title}`,
                    categoryId: categoryId,
                    points: totalPoints,
                    dueDate: new Date().toISOString().split('T')[0]
                });

                // 3. Create Grade entries for each submission
                for (const sub of submissions) {
                    const gradeRef = doc(db, `${publicPath()}/grades`, `${sub.studentId}_${newAssignmentRef.id}`);
                    await setDoc(gradeRef, {
                        studentId: sub.studentId,
                        assignmentId: newAssignmentRef.id,
                        teacherId: userData.id,
                        score: sub.score,
                        status: null,
                        comment: 'Synced from Securely Assignments tool.'
                    });
                }

                statusMsg.textContent = 'âœ… Sync complete!';
                setTimeout(() => {
                    document.getElementById('export-grades-modal').style.display = 'none';
                     const exportButton = document.querySelector(`.export-grades-btn[data-id="${assessmentId}"]`);
                     if(exportButton) {
                         exportButton.textContent = 'Synced!';
                         exportButton.disabled = true;
                     }
                }, 2000);

            } catch (error) {
                console.error("Error syncing to gradebook:", error);
                statusMsg.textContent = 'An error occurred during sync.';
                btn.disabled = false;
            }
        }

        async function reviewStudentSubmission(assessmentId, submissionId) {
            studentAssessmentDashboard.classList.add('hidden');
            const reviewView = document.getElementById('student-review-view');
            reviewView.classList.remove('hidden');
            reviewView.innerHTML = `<div class="text-center py-10">Loading your results...</div>`;

            const assessmentDoc = await getDoc(doc(db, assessmentPath(), assessmentId));
            const submissionDoc = await getDoc(doc(db, `${publicPath()}/assessment_submissions`, submissionId));

            if (!assessmentDoc.exists() || !submissionDoc.exists()) {
                reviewView.innerHTML = `<p>Error: Could not load review.</p>`;
                return;
            }

            const assessment = assessmentDoc.data();
            const submission = submissionDoc.data();
            let reviewHtml = `
                <div class="flex justify-between items-center mb-6">
                    <div>
                        <h3 class="text-3xl font-bold">${assessment.title} - Review</h3>
                        <p class="text-xl font-bold mt-2">Score: ${submission.score} / ${submission.totalPossiblePoints}</p>
                    </div>
                    <button id="back-to-review-dashboard-btn" class="bg-indigo-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-indigo-700">&larr; Back to Dashboard</button>
                </div>
            `;
           
            assessment.questions.forEach((q, index) => {
                const userAnswer = submission.answers[index];
                let isCorrect = false;
                 switch (q.questionType) {
                    case 'true-false': isCorrect = userAnswer.toString().toLowerCase() === q.correctAnswer.toString().toLowerCase(); break;
                    case 'fill-in-the-blank': isCorrect = userAnswer.trim().toLowerCase() === q.correctAnswer.trim().toLowerCase(); break;
                    case 'multiple-choice': default: isCorrect = parseInt(userAnswer) === q.correctAnswerIndex; break;
                 }

                reviewHtml += `<div class="mb-8 p-4 rounded-lg ${isCorrect ? 'bg-green-50' : 'bg-red-50'} border-l-4 ${isCorrect ? 'border-green-500' : 'border-red-500'}">`;
                reviewHtml += `<p class="font-semibold mb-4">${index + 1}. ${q.questionText}</p>`;
               
                if (q.questionType === 'multiple-choice' || q.questionType === 'true-false') {
                    const options = q.questionType === 'true-false' ? ['True', 'False'] : q.options;
                    reviewHtml += '<div class="space-y-2">';
                    options.forEach((option, optIndex) => {
                        const optionValue = q.questionType === 'true-false' ? option.toLowerCase() : optIndex.toString();
                        const isUserAnswer = userAnswer === optionValue;
                        const isCorrectAnswer = (q.questionType === 'true-false' && q.correctAnswer.toString().toLowerCase() === optionValue) || (q.questionType === 'multiple-choice' && q.correctAnswerIndex.toString() === optionValue);
                       
                        let classes = 'p-3 rounded-md border relative';
                        if (isCorrectAnswer) classes += ' correct';
                        if (isUserAnswer && !isCorrectAnswer) classes += ' incorrect';
                        if (isUserAnswer) classes += ' selected-by-user';

                        reviewHtml += `<div class="${classes}">${option}</div>`;
                    });
                    reviewHtml += '</div>';
                } else { // Fill-in-the-blank
                    reviewHtml += `<div class="p-3 rounded-md border ${isCorrect ? 'correct' : 'incorrect'}">Your Answer: <strong>${userAnswer}</strong></div>`;
                    if (!isCorrect) {
                        reviewHtml += `<div class="mt-2 p-3 rounded-md border correct">Correct Answer: <strong>${q.correctAnswer}</strong></div>`;
                    }
                }
                reviewHtml += `</div>`;
            });
            reviewView.innerHTML = reviewHtml;
        }


        async function openEditStudentModal(studentId) {
            const modal = document.getElementById('edit-user-modal');
            const form = document.getElementById('edit-user-form');
            form.reset();

            const studentDoc = await getDoc(doc(db, `${publicPath()}/all_users`, studentId));
            if (!studentDoc.exists()) {
                console.error("Student not found!");
                return;
            }
            const studentData = studentDoc.data();

            document.getElementById('edit-user-id').value = studentId;
            document.getElementById('edit-user-firstName').value = studentData.firstName;
            document.getElementById('edit-user-lastName').value = studentData.lastName;
            document.getElementById('edit-user-number').value = studentData.userNumber;

            const rosterQuery = query(collection(db, `${publicPath()}/roster_entries`), where("studentId", "==", studentId));
            const rosterSnap = await getDocs(rosterQuery);
            const currentEnrollments = {};
            rosterSnap.forEach(doc => {
                const data = doc.data();
                currentEnrollments[data.teacherId] = { className: data.className, rosterId: doc.id };
            });

            const assignListContainer = document.getElementById('edit-assign-teacher-list');
            assignListContainer.innerHTML = adminState.teachers.map(t => {
                const isEnrolled = !!currentEnrollments[t.id];
                const className = isEnrolled ? currentEnrollments[t.id].className : '';
                return `
                    <div class="flex items-center gap-2">
                        <input type="checkbox" name="edit-assign-teacher" value="${t.id}" id="edit-teacher-check-${t.id}" class="h-4 w-4 text-indigo-600" ${isEnrolled ? 'checked' : ''}>
                        <label for="edit-teacher-check-${t.id}" class="flex-grow text-sm">${t.firstName} ${t.lastName}</label>
                        <input type="text" name="edit-class-name-for-${t.id}" class="w-1/2 p-1 border rounded-md text-sm" placeholder="Class Name" value="${className}">
                    </div>
                `;
            }).join('') || '<p class="text-sm text-gray-500">No teachers available.</p>';
           
            modal.classList.remove('hidden');
        }

        async function handleUpdateUser(e) {
            e.preventDefault();
            const errorDiv = document.getElementById('edit-user-error');
            errorDiv.classList.add('hidden');
           
            const studentId = document.getElementById('edit-user-id').value;
            const firstName = toTitleCase(document.getElementById('edit-user-firstName').value.trim());
            const lastName = toTitleCase(document.getElementById('edit-user-lastName').value.trim());
            const userNumber = parseInt(document.getElementById('edit-user-number').value);

            // --- Validation ---
            if (!firstName || !lastName || !userNumber) {
                errorDiv.textContent = "Please fill out all required fields.";
                errorDiv.classList.remove('hidden');
                return;
            }
            const q = query(collection(db, `${publicPath()}/all_users`), where("userNumber", "==", userNumber));
            const existingUserSnap = await getDocs(q);
            const duplicateUser = existingUserSnap.docs.find(d => d.id !== studentId);
            if (duplicateUser) {
                errorDiv.textContent = `User Number ${userNumber} is already taken.`;
                errorDiv.classList.remove('hidden');
                return;
            }

            // --- Get form and DB states ---
            const newEnrollmentsFromForm = {};
            const selectedTeachersCheckboxes = Array.from(document.querySelectorAll('input[name="edit-assign-teacher"]:checked'));
            for (const checkbox of selectedTeachersCheckboxes) {
                const teacherId = checkbox.value;
                const classNameInput = document.querySelector(`input[name="edit-class-name-for-${teacherId}"]`);
                const className = classNameInput ? classNameInput.value.trim() : '';

                if (!className) {
                    errorDiv.textContent = `Please provide a class name for teacher: ${checkbox.nextElementSibling.textContent.trim()}.`;
                    errorDiv.classList.remove('hidden');
                    return;
                }
                newEnrollmentsFromForm[teacherId] = { className };
            }
           
            const rosterQuery = query(collection(db, `${publicPath()}/roster_entries`), where("studentId", "==", studentId));
            const rosterSnap = await getDocs(rosterQuery);
            const currentEnrollmentsInDB = {};
            rosterSnap.forEach(doc => {
                const data = doc.data();
                currentEnrollmentsInDB[data.teacherId] = { className: data.className, rosterId: doc.id };
            });

            try {
                const userDocRef = doc(db, `${publicPath()}/all_users`, studentId);
                await updateDoc(userDocRef, { firstName, lastName, userNumber });

                const allTeacherIds = new Set([...Object.keys(currentEnrollmentsInDB), ...Object.keys(newEnrollmentsFromForm)]);

                for (const teacherId of allTeacherIds) {
                    const isInDB = currentEnrollmentsInDB.hasOwnProperty(teacherId);
                    const isInForm = newEnrollmentsFromForm.hasOwnProperty(teacherId);

                    if (isInForm && !isInDB) {
                        await addDoc(collection(db, `${publicPath()}/roster_entries`), {
                            studentId, teacherId, firstName, lastName, userNumber,
                            className: newEnrollmentsFromForm[teacherId].className,
                            createdAt: serverTimestamp()
                        });
                    } else if (!isInForm && isInDB) {
                        await deleteDoc(doc(db, `${publicPath()}/roster_entries`, currentEnrollmentsInDB[teacherId].rosterId));
                    } else if (isInForm && isInDB) {
                        const rosterDocRef = doc(db, `${publicPath()}/roster_entries`, currentEnrollmentsInDB[teacherId].rosterId);
                        await updateDoc(rosterDocRef, {
                            firstName, lastName, userNumber,
                            className: newEnrollmentsFromForm[teacherId].className
                        });
                    }
                }

                document.getElementById('edit-user-modal').style.display = 'none';
            } catch (error) {
                console.error("Error updating user:", error);
                errorDiv.textContent = "An error occurred while saving changes.";
                errorDiv.classList.remove('hidden');
            }
        }
        
        // --- Live Activity Modal ---
        function openLiveActivityModal() {
            liveActivityModal.style.display = 'flex';
            const contentDiv = document.getElementById('live-activity-content');
            contentDiv.innerHTML = `<div class="text-center py-10">Loading live activity...</div>`;
            
            const activityQuery = query(collection(db, `${publicPath()}/user_activity`), where("teacherId", "==", userData.id));

            // Store the unsubscriber function with a specific key so it can be cleared when the modal closes
            unsubscribers['liveActivity'] = onSnapshot(activityQuery, (snapshot) => {
                const activities = {};
                snapshot.forEach(doc => {
                    activities[doc.id] = doc.data();
                });

                if (gradebookState.students.length === 0) {
                     contentDiv.innerHTML = `<p class="text-gray-500 text-center">No students in your roster.</p>`;
                     return;
                }
                
                let gridHtml = '<div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4">';
                gradebookState.students.forEach(student => {
                    const activity = activities[student.id];
                    let statusHtml = '<span class="text-gray-500">Offline</span>';
                    let statusBg = 'bg-white';

                    if (activity) {
                        if (activity.status === 'working') {
                            statusHtml = `Working on: <strong class="text-green-700">${activity.assignmentTitle}</strong>`;
                            statusBg = 'bg-green-50 border-green-300';
                        } else if (activity.status === 'idle') {
                            statusHtml = '<span class="text-blue-600">Idle</span>';
                            statusBg = 'bg-blue-50 border-blue-300';
                        }
                    }

                    gridHtml += `
                        <div class="p-4 rounded-lg shadow-sm border ${statusBg}">
                            <p class="font-bold text-gray-800">${student.firstName} ${student.lastName}</p>
                            <p class="text-sm mt-2">${statusHtml}</p>
                        </div>
                    `;
                });
                gridHtml += '</div>';
                contentDiv.innerHTML = gridHtml;
            });
        }
        
        // --- Confirmation Modal ---
        function showConfirmationModal(title, message, onOk) {
            document.getElementById('confirmation-title').textContent = title;
            document.getElementById('confirmation-message').innerHTML = message;
            confirmationModal.style.display = 'flex';

            const okBtn = document.getElementById('confirmation-ok-btn');
            const cancelBtn = document.getElementById('confirmation-cancel-btn');

            const okHandler = () => {
                onOk();
                confirmationModal.style.display = 'none';
                cleanup();
            };
            
            const cancelHandler = () => {
                confirmationModal.style.display = 'none';
                cleanup();
            };
            
            const cleanup = () => {
                okBtn.removeEventListener('click', okHandler);
                cancelBtn.removeEventListener('click', cancelHandler);
            };

            okBtn.addEventListener('click', okHandler);
            cancelBtn.addEventListener('click', cancelHandler);
        }


        // --- Initialization ---
        async function initialize() {
            try {
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
               
                setupGlobalListeners();
                setupDelegatedListeners();

                onAuthStateChanged(auth, async (user) => {
                     if (user) {
                        const localUserJSON = localStorage.getItem('learningSpaceUser');
                        if (localUserJSON) {
                            showApp(JSON.parse(localUserJSON));
                        } else {
                            document.getElementById('role-selection-loader').style.display = 'none';
                            document.getElementById('role-buttons').classList.remove('hidden');
                        }
                    } else {
                         if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                            await signInWithCustomToken(auth, __initial_auth_token);
                         } else {
                            await signInAnonymously(auth);
                         }
                    }
                });
            } catch (error) {
                console.error("Initialization failed:", error);
                document.body.innerHTML = '<div class="text-center p-8">Failed to initialize. Please check the console for errors.</div>';
            }
        }

        initialize();
    </script>
</body>
</html>

